# ?? ????? ????????? ??????? - ???? ????? ???????????

## ?? ???????: 2025-01-24

---

## ?? ???? ?????????

?? ????? ??????? ????? ??? ???? ????? ???????????? ???? ??????????? ????? ??????? ????:

### ? **1. ??? ?????? ?????? ?????**
- Single Term (Term ????)
- Multi-Term (??? Terms ??? 1&2 ?? 3&4)
- Subject Annual (???? ????? ?????)
- Full Year (???? ???? ?????)

### ? **2. ???? ???? ?? ?????? ?????**
- ?????? ?? ?????? ??????
- ?????? ?? ?????? ??????
- ?????? ?? ?????? ??????????
- ??? ????? ???????? ??????????

### ? **3. ???? ???????? ?????**
- Lesson Exam (?????? ???)
- Monthly Exam (?????? ????)
- Term Exam (?????? Term)
- Year Exam (?????? ???? ?????)

### ? **4. ????? ????? ??????**
- Text (???? ???)
- Multiple Choice (?????? ????)
- Multiple Select (?????? ?????)
- True/False (?? ?? ???)

---

## ?? ????????? ??? ??? Entities

### 1. **SubscriptionPlan Entity** ?
**?????**: `API/Entities/SubscriptionPlan.cs`

**?????????**:
```csharp
// ????? enum ????
public enum PlanType
{
    SingleTerm = 1,      // Term ????
    MultiTerm = 2,       // ??? Terms
    FullYear = 3,        // ????? ???????
    SubjectAnnual = 4    // ???? ?????
}

// ????? ???? ?????
public int DurationInDays { get; set; }
public string? IncludedTermIds { get; set; }  // "1,2" ?? "3,4"
```

---

### 2. **Exam Entity** ?
**?????**: `API/Entities/Exam.cs`

**?????????**:
```csharp
// ????? enum ????
public enum ExamType
{
    Lesson = 1,    // ?????? ???
    Monthly = 2, // ?????? ????
    Term = 3,      // ?????? Term
    Year = 4       // ?????? ????
}

// ????? ???? ?????
public ExamType ExamType { get; set; }
public int? LessonId { get; set; }
public int? WeekId { get; set; }
public float PassingMarks { get; set; }
public bool IsPublished { get; set; }
```

---

### 3. **ExamQuestion Entity** ?
**?????**: `API/Entities/ExamQuestion.cs`

**?????????**:
```csharp
// ????? enum ????
public enum QuestionType
{
    Text = 1,   // ???? ???
    MultipleChoice = 2,  // ?????? ????
    MultipleSelect = 3,  // ?????? ?????
    TrueFalse = 4        // ?? ?? ???
}

// ????? ???? ?????
public QuestionType QuestionType { get; set; }
public int Order { get; set; }
```

---

### 4. **LessonQuestion Entity** ?
**?????**: `API/Entities/LessonQuestion.cs`

**?????????**:
```csharp
// ????? QuestionType
public QuestionType QuestionType { get; set; }

// ????? ???????
public bool IsMultipleChoice { get; set; }  // ??? MCQ
public int VideoMinute { get; set; } // ??????? ?? ???????
```

---

## ?? ????????? ??? ??? Services

### 1. **SubscriptionService** ?
**?????**: `API/Services/Implementations/SubscriptionService.cs`

**??????? ???????**:

#### ?. `HasActiveSubscriptionAsync`
```csharp
// ?????? ?? ???? ?????? ??? ?? ????
public async Task<bool> HasActiveSubscriptionAsync(int studentId, int subjectId)
```

**??????**:
- ?????? ????? ?? ?????? ?
- ?? ?????? ?? Year ????? ?????? ?

---

#### ?. `HasAccessToLessonAsync`
```csharp
// ?????? ?? ???? ?????
public async Task<bool> HasAccessToLessonAsync(int studentId, int lessonId)
```

**??????**:
- ?????? ?? ?????? ?
- ?? ?????? ?? Term ?????? ?
- ?? ?????? ?? Year ?????? ?
- ?? ?????? ?? MultiTerm ???? ??? Term ?

---

#### ?. `HasAccessToExamAsync`
```csharp
// ?????? ?? ???? ????????
public async Task<bool> HasAccessToExamAsync(int studentId, int examId)
```

**??????**: ??? ???? ?????

---

#### ?. `GetAvailableSubjectIdsForStudentAsync`
```csharp
// ?????? ??? IDs ?????? ???????
public async Task<List<int>> GetAvailableSubjectIdsForStudentAsync(int studentId)
```

**??????**:
- ??? ?????? ?? ???? ?????????? ??????
- ??? Single Subject, Term, MultiTerm, FullYear

---

#### ??. `CalculateEndDate` (?????)
```csharp
// ???? ????? ?????? ???????? ????? ??? ??? ?????
private DateTime CalculateEndDate(SubscriptionPlan plan)
```

**??????**:
- SingleTerm ? 90 ???
- MultiTerm ? 180 ???
- SubjectAnnual ? 365 ???
- FullYear ? 365 ???

---

### 2. **SubscriptionPlanService** ?
**?????**: `API/Services/Implementations/SubscriptionPlanService.cs`

**?????????**:
```csharp
// ????? GetCoverageDescription
private string GetCoverageDescription(SubscriptionPlan plan)
{
    return plan.PlanType switch
    {
        PlanType.SingleTerm => "Subject - Term X",
        PlanType.MultiTerm => "Multiple Terms - 1,2",
        PlanType.SubjectAnnual => "Subject - Full Year",
        PlanType.FullYear => "All Subjects - Grade X",
        _ => "Unknown coverage"
    };
}
```

---

## ?? Controller ????: StudentSubjectsController ?

**?????**: `API/Controllers/StudentSubjectsController.cs`

### Endpoints:

#### 1. ?????? ??? ?????? ???????
```http
GET /api/studentsubjects/student/{studentId}/available-subjects
```

**?????**: ???? ???? ?????? ???? ??? ?????? ?????? ??? ????

---

#### 2. ?????? ?? ???? ?????
```http
GET /api/studentsubjects/student/{studentId}/has-access/subject/{subjectId}
```

**?????**: `true` ?? `false`

---

#### 3. ?????? ?? ???? ????
```http
GET /api/studentsubjects/student/{studentId}/has-access/lesson/{lessonId}
```

**?????**: `true` ?? `false`

---

#### 4. ?????? ?? ???? ???????
```http
GET /api/studentsubjects/student/{studentId}/has-access/exam/{examId}
```

**?????**: `true` ?? `false`

---

#### 5. ???? ??????????
```http
GET /api/studentsubjects/student/{studentId}/subscriptions-summary
```

**?????**: ????? ????? ?????????? ?????? ?? ????????

---

## ?? ??????? ??????

### 1. **PAYMENT_SUBSCRIPTION_GUIDE.md** ?
**?????**: `API/PAYMENT_SUBSCRIPTION_GUIDE.md`

**???????**:
- ??? ?????? ??? ??? ???
- ???? ????? ?????? (7 ?????)
- ????? ?????? ??? ?????? ???????
- ?????? ?? ??????
- ???? ??????? ???????
- ???? ?????????? ???????
- ????? ????? ??? Front-end

---

### 2. **API_DOCUMENTATION_FOR_FRONTEND.md** (?????) ?
**?????**: `API/API_DOCUMENTATION_FOR_FRONTEND.md`

**?????????**:
- ??? **13B: Student Subjects** (????)
- ????? ??? **Subscription Plans**
- ????? ??? **Exams** ?? ????? ??????????
- ????? ????? ??????? ????????
- ????? Request/Response ??????

---

## ??? Database Migration

**??? Migration**: `EnhancedSubscriptionsAndExams`

**?????????**:
- ????? `SubscriptionPlan` table
- ????? `Exam` table
- ????? `ExamQuestion` table
- ????? `LessonQuestion` table

**?????? Migration**:
```bash
cd API
dotnet ef database update
```

---

## ?? ???? ????? ??????

### 1?? ??? ????? ????? ?????
```
GET /api/subscriptionplans/student/{studentId}/available
? ??? ???? ????? ??????? ??????
```

### 2?? ?????? ??? ???????? ?????
```
POST /api/cart/add
{
  "subscriptionPlanId": 2,  // MultiTerm plan
  "studentId": 5,
  "quantity": 1
}
```

### 3?? ????? Order
```
POST /api/order/create-from-cart
? Order Status: Pending
```

### 4?? ????? ??? Stripe
```
POST /api/payment/create-checkout-session
{
  "orderId": 1,
  "successUrl": "...",
  "cancelUrl": "..."
}
? ????? ?? Stripe Checkout
```

### 5?? Stripe Webhook (??????)
```
POST /api/stripewebhook
? Order Status: Paid
? ????? Subscriptions ????????
? ????? ???????
```

### 6?? ?????? ??? ?????? ???????
```
GET /api/studentsubjects/student/{studentId}/available-subjects
? ????? ?????? ???? ???? ???? ???
```

### 7?? ?????? ???? ???
```
1. GET /api/studentsubjects/student/{studentId}/has-access/lesson/{lessonId}
   ? ?????? ?? ??????
   
2. ??? true ? GET /api/lessons/{lessonId}
   ? ??? ?????
   
3. ??? false ? ??? ????? Upgrade
```

---

## ?? ????? ????? ??? Front-end

### ???? 1: ??? ?????? ??????? ???
```typescript
async function loadAvailableSubjects(studentId: number) {
  const response = await fetch(
    `/api/studentsubjects/student/${studentId}/available-subjects`,
    {
      headers: {
        'Authorization': `Bearer ${token}`
      }
  }
  );
  
  const subjects = await response.json();
  
  // ??? ?????? ??? ???? ???? ???? ???
  displaySubjects(subjects);
}
```

---

### ???? 2: ?????? ??? ??? ???
```typescript
async function openLesson(studentId: number, lessonId: number) {
  // ?????? ?? ??????
  const hasAccess = await checkAccess(studentId, lessonId);
  
  if (!hasAccess) {
    showUpgradeModal({
      message: "You need an active subscription to access this lesson",
 availablePlans: await fetchPlansForLesson(lessonId)
    });
    return;
}
  
  // ??? ?????
  navigateTo(`/lesson/${lessonId}`);
}

async function checkAccess(studentId: number, lessonId: number): Promise<boolean> {
  const response = await fetch(
    `/api/studentsubjects/student/${studentId}/has-access/lesson/${lessonId}`,
    {
      headers: { 'Authorization': `Bearer ${token}` }
    }
  );
  
  return await response.json();
}
```

---

### ???? 3: ??? ???? ??????????
```typescript
async function loadSubscriptionsSummary(studentId: number) {
  const response = await fetch(
    `/api/studentsubjects/student/${studentId}/subscriptions-summary`,
    {
      headers: { 'Authorization': `Bearer ${token}` }
}
  );
  
const summary = await response.json();
  
  // ??? ??? ??????????
  document.getElementById('active-subs-count').textContent = 
    summary.totalActiveSubscriptions;
  
  // ??? ?????? ?? ??????
  summary.subscriptions.forEach(sub => {
    displaySubscriptionCard({
      name: sub.planName,
      type: sub.planType,
      expiresIn: `${sub.daysRemaining} days`,
      endDate: new Date(sub.endDate)
    });
  });
}
```

---

### ???? 4: ????? ?????? ?????
```typescript
async function createExam() {
  const exam = {
    title: "Algebra Term 1 Final",
    examType: "Term",
    subjectId: 1,
    termId: 1,
    durationInMinutes: 120,
    totalMarks: 100,
    passingMarks: 50,
    questions: [
      // Multiple Choice
  {
questionText: "What is 2 + 2?",
        questionType: "MultipleChoice",
  marks: 5,
        order: 1,
        options: [
          { optionText: "3", isCorrect: false },
          { optionText: "4", isCorrect: true }
        ]
      },
      // Multiple Select
      {
      questionText: "Select prime numbers",
        questionType: "MultipleSelect",
        marks: 10,
        order: 2,
        options: [
 { optionText: "2", isCorrect: true },
       { optionText: "3", isCorrect: true },
          { optionText: "4", isCorrect: false },
    { optionText: "5", isCorrect: true }
  ]
},
      // Text
      {
      questionText: "Explain Newton's first law",
   questionType: "Text",
        marks: 15,
        order: 3
      },
      // True/False
      {
        questionText: "The Earth is round",
questionType: "TrueFalse",
        marks: 2,
        order: 4,
        options: [
  { optionText: "True", isCorrect: true },
          { optionText: "False", isCorrect: false }
        ]
      }
    ]
  };
  
  const response = await fetch('/api/exam', {
  method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(exam)
  });
  
  return await response.json();
}
```

---

## ? ????? ??????

```
Build: ? Successful
Migration: ? Created (EnhancedSubscriptionsAndExams)
Tests: ? All Passing
```

---

## ?? ???????? ???????

| ?????? | ??? | ??? |
|--------|-----|-----|
| ????? ????? | 3 | 4 |
| ????? ?????????? | 0 | 4 |
| ????? ??????? | 1 | 4 |
| Endpoints ?????? | 0 | 5 |
| ????? ??????? | 5 | 7 |

---

## ?? ????????? ?????????? ????????

### 1. Subscription Overlap Prevention ?
- ??? ????? ??????????
- ????? ??? ???? ??? ?????

### 2. Automatic Subscription Renewal ?
- ????? ?????? ??????????
- ??????? ??? ????????

### 3. Promo Codes & Discounts ?
- ??????? ???
- ???? ????

### 4. Gift Subscriptions ?
- ????? ????????
- Vouchers

### 5. Analytics Dashboard ?
- ?????? ????????
- ????? ???? ?????

---

## ?? ?????

??? ??? ???? ?? ????????? ??? ?????????:

1. ???? `PAYMENT_SUBSCRIPTION_GUIDE.md` ???????? ???????
2. ???? `API_DOCUMENTATION_FOR_FRONTEND.md` ??? API Reference
3. ????? ?? ???? ???????

---

**??? ?????**: 2025-01-24  
**???????**: 2.0  
**Build Status**: ? Successful

