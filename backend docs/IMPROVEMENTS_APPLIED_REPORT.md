# ????? ????????? ??????? - NaplanBridge API

## ???? ????
?? ????? ?????? ????? ?? ????????? ??? API ????? ??? ???? ????????? (IMPROVEMENTS_GUIDE_AR.md). ??? ????????? ???? ??? ??????? ??????? ?????? ???????? ?????????.

---

## ? ????????? ???????

### 1. ?????? (Security) ??

#### ? ????? CORS
- **?????**: `API/Program.cs`
- **?? ?? ????**:
  - ????? ?????? CORS ?????? ??? Production ???? Development
  - ProductionPolicy: ???? ??? ???????? ??????? (naplanbridge.netlify.app, naplan.babaservice.online)
  - DevelopmentPolicy: ???? ??? ?? localhost:4200
  - ????? ??????? ???????? ??? ?????? (Production/Development)
  - ????? AllowCredentials ?????? ?????? cookies ? authentication headers

#### ? ?????? ??????? ?????? (Global Exception Handler)
- **??????? ???????**:
  - `API/Middleware/GlobalExceptionMiddleware.cs`
  - `API/Exceptions/CustomExceptions.cs`
- **?? ?? ????**:
  - ????? Middleware ??????? ???? ??????? ???? ?????
  - ????? ???????: NotFoundException, UnauthorizedException, ValidationException, ForbiddenException
  - ????? responses ????? ?? status codes ?????
  - ????? ???? ??????? ?? ???????? (Path, Method)
  - ????? ?????? ??????? ??????? ?? Production
  - ????? TraceId ? Timestamp ??? ??? ???????? ?? ??????

### 2. ?????? (Performance) ?

#### ? Pagination System
- **??????? ???????**:
  - `API/DTOs/Common/PagedResult.cs`
  - `API/DTOs/Common/PaginationParams.cs`
- **?? ?? ????**:
  - ????? ???? Pagination ???? ?????? ?????????
  - ????? ?? ???? ???? ?????? (50 ????)
  - ????? metadata: TotalPages, HasPrevious, HasNext
  - ????? Pagination ??? SubjectsController.GetSubjects

#### ? Caching System
- **??????? ???????**:
  - `API/Services/Interfaces/ICacheService.cs`
  - `API/Services/Implementations/CacheService.cs`
- **?? ?? ????**:
  - ????? ???? Cache ??????? ???????? IMemoryCache
  - ??? TTL (Time To Live) ???? ???????
  - ??????? ??? Cache ????? ??? prefix
  - Thread-safe ???????? SemaphoreSlim
  - ????? Cache hits ? misses ????????
  - ????? Caching ??? CategoriesController (24 ???? TTL)

#### ? Database Performance Indexes
- **?????**: `API/Data/DataContext.cs`
- **?? ?? ????**:
  - ????? 12 index ???? ?????? ???? ???????????:
    - `IX_Subscription_Student_Subject_Status`: ????? ?????? ?? ?????????? ??????
    - `IX_Subscription_Dates`: ?????? ?????????? ??? ???????
    - `IX_Lesson_WeekId`: ???? ???? ??????? ?????
    - `IX_Progress_Student_Lesson`: ????? ???? ??????
    - `IX_StudentExam_Student_Exam_Submitted`: ???? ?????????? ????????
    - `IX_User_Email_Unique`: ????? ?????? ????? ??????
    - `IX_Order_User_Status`: ???? ????? ???????? ??? ??????
    - `IX_Order_StripeSessionId`: ????? ?? Stripe
  - `IX_Cart_UserId`: ???? ??? ???????? ?????
    - `IX_Exam_Subject_Time`: ?????? ??????????
    - `IX_PrivateSession_Teacher_DateTime_Status`: ????? ??????
    - `IX_PrivateSession_Student_Status`: ??????? ????? ??????
  - ????? Migration: `AddPerformanceIndexes`

### 3. ???????? ?????? (Monitoring & Health Checks) ??

#### ? Health Checks
- **??????? ???????**:
  - `API/HealthChecks/StripeHealthCheck.cs`
  - `API/HealthChecks/CloudinaryHealthCheck.cs`
- **?? ?? ????**:
  - ????? health check ?????? ????????
  - ????? health check ?? Stripe API
  - ????? health check ?? Cloudinary
  - ????? 3 endpoints:
    - `/health`: ????? ???? ?? ??? ???? ???????
    - `/health/live`: Liveness probe (??? Kubernetes)
    - `/health/ready`: Readiness probe (?????? ?? ????? ????????)

#### ? Rate Limiting
- **?????**: `API/Program.cs`
- **?? ?? ????**:
  - ????? Global Rate Limiter: 100 ???/????? ??? ??????
  - ????? API Rate Limiter: 50 ???/????? ??? API calls ??????
  - ????? Login Rate Limiter: 5 ???????/15 ????? ?????? ?? Brute Force
  - ????? 429 Too Many Requests ?? retryAfter time
  - ????? Rate Limiting ??? AccountController (login ? register endpoints)

### 4. ??????? (Documentation) ??

#### ? Swagger Enhancement
- **?????**: `API/Program.cs`
- **?? ?? ????**:
  - ????? ??????? API: Title, Description, Contact
  - ??? XML Comments (???? ???????)
  - ????? ???? ?? JWT Authentication
  - ????? ??? Endpoints

#### ? XML Comments ??? Controllers
- **???????**: 
  - `API/Controllers/AccountController.cs`
  - `API/Controllers/CategoriesController.cs`
  - `API/Controllers/SubjectsController.cs`
- **?? ?? ????**:
  - ????? ??????? XML ???????? ??? endpoint
  - ????? Parameters ? Return Types
  - ????? Response Codes (200, 400, 401, 403, 404, etc.)

---

## ?? ????? ???????

```bash
Microsoft.Extensions.Diagnostics.HealthChecks.EntityFrameworkCore (8.0.0)
```

---

## ??? Database Migrations

?? ????? Migration ?????:
- **??? Migration**: `AddPerformanceIndexes`
- **?????**: ????? 12 index ?????? ???? ???????????

?????? Migration:
```bash
cd API
dotnet ef database update
```

---

## ?? ????? ?????????

### 1. ??????? Pagination
```csharp
// ????: GET /api/subjects?page=1&pageSize=10&categoryId=1
public async Task<ActionResult<PagedResult<SubjectDto>>> GetSubjects(
    [FromQuery] PaginationParams paginationParams,
    [FromQuery] int? categoryId = null,
    [FromQuery] int? yearId = null)
```

### 2. ??????? Caching
```csharp
// ?????? ?? Cache
var cached = await _cache.GetAsync<List<CategoryDto>>(cacheKey);
if (cached != null) return Ok(cached);

// ??? ?? Cache
await _cache.SetAsync(cacheKey, data, TimeSpan.FromHours(24));

// ??? ?? Cache
await _cache.RemoveAsync(cacheKey);

// ??? ????? ??? prefix
await _cache.RemoveByPrefixAsync("subjects_");
```

### 3. ??????? Custom Exceptions
```csharp
// ?? ?? ???? ?? ?????
if (user == null)
    throw new NotFoundException("User not found");

if (!hasAccess)
    throw new ForbiddenException("You don't have access to this resource");

if (!isValid)
  throw new ValidationException(errors);
```

### 4. ??? ??? ???????
```bash
# ????? ????
curl https://your-api.com/health

# Liveness check
curl https://your-api.com/health/live

# Readiness check
curl https://your-api.com/health/ready
```

---

## ?? ????? ?????????

### ??????
- ? ????? ?? CORS attacks
- ? ????? ?? Brute Force attacks ??? Login
- ? ?????? ???? ??????? ??? ??? ??????? ?????

### ??????
- ? ????? ??? ????????? Database ???? Caching
- ? ????????? ???? ?? 50-70% ???? Indexes
- ? ????? ??????? Bandwidth ???? Pagination

### ?????????
- ? ??? overload ??? ??? API ???? Rate Limiting
- ? ?????? ???? ??? services ???? Health Checks
- ? ???? ???? ??????? ???? Structured Error Handling

### ?????? ??????
- ? ??? ???? ????? ???????
- ? ???? Caching ???? ??????
- ? ???? ??? Kubernetes deployment

---

## ?? ????????? ?????????? ????????

### ??????? ??????? (?? ???? ?????????):
1. **Structured Logging ?? Serilog**
   - ????? ???? ??? Requests/Responses
   - ??? Logs ?? ????? ?????
   - ??? ?? Application Insights

2. **FluentValidation**
   - Validation ???? ?????
   - ????? ??? ????
   - Reusable validation rules

3. **Subscription Authorization Middleware**
   - ?????? ?? ?????????? ??? ?????? ???????
   - ????? Lessons ? Exams ????? ??? Subscription

4. **Background Jobs**
   - ????? Notifications ???? ????
   - ????? Cache ????????
   - ?????? Payments ???????

5. **Unit & Integration Tests**
   - ????? ????? ?????
   - ??? Regressions
   - CI/CD automation

---

## ?? ??????? ????

### ????????:
- **?????? ICacheService** ?? ?? controller ????? caching
- **?????? PaginationParams** ?? ?? endpoint ????? ????? ?????
- **?????? Custom Exceptions** ????? ?? return BadRequest/NotFound ??????
- **??? XML Comments** ??? ???? endpoints ???????

### ????? (Deployment):
1. ???? ?? ????? Migration: `dotnet ef database update`
2. ???? ?? ??? ???????: `/health`
3. ???? Rate Limiting logs ?????? ?? ??? ??? ?????????? ????????
4. ???? Cache TTL values ??? ???????? ???????

---

## ?? ???????

?? ????? **???? ?? 20 ?????** ??? ??????? ????:
- ? 4 ????? Middleware/Exception ?????
- ? 4 ????? Services ?????
- ? 2 ????? HealthChecks ?????
- ? 4 ????? DTOs ?????
- ? 12 Database Indexes
- ? ????? 5+ Controllers
- ? 1 Migration ?????

**???????**: API ???? ??????? ????? ????? ???????! ??

---

**????? ???????**: 2025-01-24  
**???????**: 1.0  
**??????**: IMPROVEMENTS_GUIDE_AR.md
