<!-- Student Details Page (Parent View) -->
<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- Loading State -->
    @if (loading()) {
      <div class="flex justify-center items-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <p class="ml-4 text-gray-600">Loading student details...</p>
      </div>
    }

    <!-- Error State -->
    @if (error() && !loading()) {
      <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
        <h3 class="text-lg font-semibold text-red-900 mb-2">Error</h3>
        <p class="text-red-700 mb-4">{{ error() }}</p>
        <div class="flex gap-3 justify-center">
          <button
            (click)="loadStudentDetails()"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
            Retry
          </button>
          <button
            (click)="goBack()"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
            Go Back
          </button>
        </div>
      </div>
    }

    <!-- Content -->
    @if (hasData() && !loading()) {
      <!-- Header -->
      <div class="mb-6">
        <button
          (click)="goBack()"
          class="text-blue-600 hover:text-blue-700 flex items-center gap-2 mb-4">
          <span>‚Üê</span>
          <span>Back to Dashboard</span>
        </button>

        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="bg-blue-600 p-6 text-white">
            <div class="flex items-center gap-6">
              <!-- Avatar -->
              <img
                [src]="getAvatarUrl()"
                [alt]="studentDetails()!.student.userName"
                class="w-24 h-24 rounded-full border-4 border-white">

              <!-- Info -->
              <div class="flex-1">
                <h1 class="text-3xl font-bold mb-2">{{ studentDetails()!.student.userName }}</h1>
                <p class="text-blue-100 mb-1">{{ studentDetails()!.student.email }}</p>
                <p class="text-blue-100">{{ studentDetails()!.student.yearName }} ‚Ä¢ Age: {{ studentDetails()!.student.age }}</p>
              </div>

              <!-- Quick Stats -->
              <div class="grid grid-cols-3 gap-6 text-center">
                <div>
                  <div class="text-3xl font-bold">{{ studentDetails()!.progress.overallProgress }}%</div>
                  <div class="text-sm text-blue-100">Overall Progress</div>
                </div>
                <div>
                  <div class="text-3xl font-bold">{{ studentDetails()!.progress.averageScore }}%</div>
                  <div class="text-sm text-blue-100">Avg Score</div>
                </div>
                <div>
                  <div class="text-3xl font-bold">{{ studentDetails()!.activeSubscriptions.length }}</div>
                  <div class="text-sm text-blue-100">Active Plans</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
              <button
                (click)="switchTab('overview')"
                [class]="activeTab() === 'overview' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="py-4 px-6 border-b-2 font-medium text-sm transition-colors">
                Overview
              </button>
              <button
                (click)="switchTab('subscriptions')"
                [class]="activeTab() === 'subscriptions' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="py-4 px-6 border-b-2 font-medium text-sm transition-colors">
                Subscriptions
              </button>
              <button
                (click)="switchTab('progress')"
                [class]="activeTab() === 'progress' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="py-4 px-6 border-b-2 font-medium text-sm transition-colors">
                Progress
              </button>
              <button
                (click)="switchTab('settings')"
                [class]="activeTab() === 'settings' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="py-4 px-6 border-b-2 font-medium text-sm transition-colors">
                Settings
              </button>
            </nav>
          </div>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="space-y-6">

        <!-- Overview Tab -->
        @if (activeTab() === 'overview') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Progress Card -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <span>üìä</span>
                <span>Learning Progress</span>
              </h3>
              <div class="space-y-4">
                <div>
                  <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600">Overall Completion</span>
                    <span class="font-semibold">{{ studentDetails()!.progress.overallProgress }}%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-3">
                    <div
                      [class]="'h-full rounded-full transition-all ' + getProgressColor(studentDetails()!.progress.overallProgress)"
                      [style.width.%]="studentDetails()!.progress.overallProgress">
                    </div>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                  <div>
                    <div class="text-2xl font-bold text-gray-900">{{ studentDetails()!.progress.completedLessons }}</div>
                    <div class="text-sm text-gray-600">Lessons Completed</div>
                  </div>
                  <div>
                    <div class="text-2xl font-bold text-gray-900">{{ formatTime(studentDetails()!.progress.timeSpent) }}</div>
                    <div class="text-sm text-gray-600">Time Spent</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stats Card -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <span>üìà</span>
                <span>Statistics</span>
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                  <div class="text-2xl font-bold text-blue-600">{{ studentDetails()!.stats.completionRate }}%</div>
                  <div class="text-xs text-blue-900 mt-1">Completion Rate</div>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-lg">
                  <div class="text-2xl font-bold text-green-600">{{ studentDetails()!.stats.totalExamsPassed }}/{{ studentDetails()!.stats.totalExamsTaken }}</div>
                  <div class="text-xs text-green-900 mt-1">Exams Passed</div>
                </div>
                <div class="text-center p-3 bg-amber-50 rounded-lg">
                  <div class="text-sm font-bold text-amber-600">{{ studentDetails()!.stats.strongestSubject }}</div>
                  <div class="text-xs text-amber-900 mt-1">Strongest Subject</div>
                </div>
                <div class="text-center p-3 bg-orange-50 rounded-lg">
                  <div class="text-sm font-bold text-orange-600">{{ studentDetails()!.stats.weakestSubject }}</div>
                  <div class="text-xs text-orange-900 mt-1">Needs Improvement</div>
                </div>
              </div>
            </div>

          </div>

          <!-- Subjects -->
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <span>üìö</span>
              <span>Subjects</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              @for (subject of studentDetails()!.subjects; track subject.subjectId) {
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                  <div class="flex justify-between items-start mb-2">
                    <h4 class="font-semibold text-gray-900">{{ subject.subjectName }}</h4>
                    @if (subject.hasActiveSubscription) {
                      <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Active</span>
                    }
                  </div>
                  <div class="mb-2">
                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                      <span>Progress</span>
                      <span>{{ subject.progress }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      <div
                        [class]="'h-full rounded-full ' + getProgressColor(subject.progress)"
                        [style.width.%]="subject.progress">
                      </div>
                    </div>
                  </div>
                  <div class="text-sm text-gray-600">
                    {{ subject.completedLessons }} / {{ subject.totalLessons }} lessons
                  </div>
                  @if (subject.lastAccessed) {
                    <div class="text-xs text-gray-500 mt-2">
                      Last: {{ subject.lastAccessed | date:'short' }}
                    </div>
                  }
                </div>
              }
            </div>
          </div>

          <!-- Recent Activities & Upcoming Exams -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Recent Activities -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <span>üéØ</span>
                <span>Recent Activities</span>
              </h3>
              <div class="space-y-3">
                @for (activity of studentDetails()!.recentActivities; track activity.id) {
                  <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                    <div [class]="activity.type === 'lesson' ? 'text-blue-500' : 'text-green-500'" class="text-2xl">
                      {{ activity.type === 'lesson' ? 'üìñ' : 'üìù' }}
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="text-sm font-medium text-gray-900">{{ activity.description }}</div>
                      <div class="text-xs text-gray-600 mt-1">
                        {{ activity.subject }} ‚Ä¢ {{ activity.date | date:'MMM d, yyyy' }}
                      </div>
                      @if (activity.score !== null) {
                        <div class="text-xs text-green-600 font-medium mt-1">
                          Score: {{ activity.score }}%
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Upcoming Exams -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <span>üìÖ</span>
                <span>Upcoming Exams</span>
              </h3>
              @if (filteredUpcomingExams().length > 0) {
                <div class="space-y-3">
                  @for (exam of filteredUpcomingExams(); track exam.examId) {
                    <div class="p-3 border border-gray-200 rounded-lg">
                      <div class="font-semibold text-gray-900">{{ exam.title }}</div>
                      <div class="text-sm text-gray-600 mt-1">{{ exam.subject }}</div>
                      <div class="flex items-center justify-between mt-2 text-xs">
                        <span class="text-gray-500">{{ exam.startDate | date:'MMM d, h:mm a' }}</span>
                        <span class="text-blue-600 font-medium">{{ exam.duration }}min ‚Ä¢ {{ exam.totalMarks }} marks</span>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center py-8 text-gray-500">
                  <div class="text-4xl mb-2">üì≠</div>
                  <p>No upcoming exams</p>
                  @if (studentDetails()!.activeSubscriptions.length === 0) {
                    <p class="text-sm mt-2">Subscribe to subjects to access exams</p>
                  }
                </div>
              }
            </div>

          </div>
        }

        <!-- Subscriptions Tab -->
        @if (activeTab() === 'subscriptions') {
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-lg font-semibold text-gray-900">Active Subscriptions</h3>
              <button
                (click)="addSubscription()"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                <span>‚ûï</span>
                <span>Add Subscription</span>
              </button>
            </div>

            @if (studentDetails()!.activeSubscriptions.length > 0) {
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                @for (sub of studentDetails()!.activeSubscriptions; track sub.id) {
                  <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                      <h4 class="font-semibold text-gray-900">{{ sub.planName }}</h4>
                      <span [class]="getDaysRemainingColor(sub.daysRemaining)" class="text-xs px-2 py-1 rounded-full">
                        {{ sub.daysRemaining }} days left
                      </span>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                      <div>{{ sub.subject }}</div>
                      <div>{{ sub.planType }}</div>
                      <div class="font-semibold text-indigo-600">${{ sub.price }}</div>
                    </div>
                    <div class="mt-3 pt-3 border-t text-xs text-gray-500">
                      <div>Started: {{ sub.startDate | date:'MMM d, yyyy' }}</div>
                      <div>Expires: {{ sub.expiryDate | date:'MMM d, yyyy' }}</div>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="text-center py-12">
                <div class="text-6xl mb-4">üì≠</div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No Active Subscriptions</h3>
                <p class="text-gray-600 mb-4">This student doesn't have any active subscriptions</p>
                <button
                  (click)="addSubscription()"
                  class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                  Browse Plans
                </button>
              </div>
            }
          </div>
        }

        <!-- Progress Tab -->
        @if (activeTab() === 'progress') {
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">Subject Progress Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              @for (subject of studentDetails()!.subjects; track subject.subjectId) {
                <button
                  (click)="viewSubjectProgress(subject.subjectId)"
                  class="text-left border border-gray-200 rounded-lg p-4 hover:border-indigo-300 hover:bg-indigo-50 transition-all">
                  <h4 class="font-semibold text-gray-900 mb-2">{{ subject.subjectName }}</h4>
                  <div class="text-3xl font-bold text-indigo-600 mb-1">{{ subject.progress }}%</div>
                  <div class="text-sm text-gray-600">{{ subject.completedLessons }}/{{ subject.totalLessons }} lessons</div>
                  <div class="mt-2 text-xs text-indigo-600 font-medium">View Details ‚Üí</div>
                </button>
              }
            </div>
          </div>
        }

        <!-- Settings Tab -->
        @if (activeTab() === 'settings') {
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-lg font-semibold text-gray-900">Student Profile Settings</h3>
              @if (!editMode()) {
                <button
                  (click)="toggleEditMode()"
                  class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                  Edit Profile
                </button>
              }
            </div>

            <form class="max-w-2xl space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Student Name</label>
                <input
                  type="text"
                  [(ngModel)]="editForm().userName"
                  name="userName"
                  [disabled]="!editMode()"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input
                  type="email"
                  [(ngModel)]="editForm().email"
                  name="email"
                  [disabled]="!editMode()"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                  <input
                    type="number"
                    [(ngModel)]="editForm().age"
                    name="age"
                    [disabled]="!editMode()"
                    min="1"
                    max="150"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                  <select
                    [(ngModel)]="editForm().yearId"
                    name="yearId"
                    [disabled]="!editMode()"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option [value]="undefined" disabled>Select Year</option>
                    @for (year of years(); track year.id) {
                      <option [value]="year.id">Year {{ year.yearNumber }}</option>
                    }
                  </select>
                </div>
              </div>

              @if (editMode()) {
                <div class="flex gap-3 pt-4">
                  <button
                    type="button"
                    (click)="saveProfile()"
                    [disabled]="saving()"
                    class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    {{ saving() ? 'Saving...' : 'Save Changes' }}
                  </button>
                  <button
                    type="button"
                    (click)="toggleEditMode()"
                    [disabled]="saving()"
                    class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    Cancel
                  </button>
                </div>
              }
            </form>
          </div>
        }

      </div>
    }

  </div>
</div>
