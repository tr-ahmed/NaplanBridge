<div class="profile-edit-container">
  <div class="profile-edit-card">
    <h2 class="page-title">Edit Profile</h2>

    <!-- Loading State -->
    <div class="loading-spinner" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Loading profile data...</p>
    </div>

    <!-- Main Form -->
    <form [formGroup]="profileForm" (ngSubmit)="updateProfile()" *ngIf="!isLoading">

      <!-- Avatar Section -->
      <div class="avatar-section">
        <h3 class="section-title">Profile Picture</h3>

        <!-- Avatar Preview -->
        <div class="avatar-preview-container">
          <img [src]="avatarPreview || 'https://upload.wikimedia.org/wikipedia/commons/2/2c/Default_pfp.svg'" alt="Profile Picture" class="avatar-image">
          <div class="avatar-overlay">
            <span class="avatar-label">Avatar</span>
          </div>
        </div>

        <!-- Upload Buttons -->
        <div class="avatar-actions">
          <input
            type="file"
            #fileInput
            (change)="onFileSelected($event)"
            accept="image/*"
            style="display: none">

          <button
            type="button"
            class="btn btn-primary"
            (click)="fileInput.click()"
            [disabled]="isSaving">
            <i class="fas fa-camera"></i> Change Picture
          </button>

          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="cancelAvatarSelection()"
            *ngIf="selectedFile"
            [disabled]="isSaving">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>

        <small class="form-text text-muted">
          Supported formats: JPG, PNG, GIF. Max size: 5MB
        </small>
      </div>

      <!-- Form Fields Section -->
      <div class="form-fields-section">
        <h3 class="section-title">Account Information</h3>

        <!-- Username Field -->
        <div class="form-group">
          <label for="userName">Username</label>
          <div style="position: relative;">
            <input
              id="userName"
              type="text"
              class="form-control"
              formControlName="userName"
              [disabled]="isSaving"
              placeholder="Enter your username">
            <div *ngIf="checkingUsername()" style="position: absolute; right: 10px; top: 10px;">
              <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            </div>
          </div>
          <div class="error-message" *ngIf="hasError('userName', 'required')">
            <small><i class="fas fa-exclamation-circle"></i> Username is required</small>
          </div>
          <div class="error-message" *ngIf="hasError('userName', 'minlength')">
            <small><i class="fas fa-exclamation-circle"></i> Username must be at least 3 characters</small>
          </div>
          <div class="error-message" *ngIf="hasError('userName', 'usernameTaken')">
            <small><i class="fas fa-exclamation-circle"></i> ❌ This username is already taken</small>
          </div>
          <small class="text-success" *ngIf="!hasError('userName', 'usernameTaken') && !checkingUsername() && profileForm.get('userName')?.valid && profileForm.get('userName')?.touched && profileForm.get('userName')?.value !== originalUsername">
            <i class="fas fa-check-circle"></i> ✅
          </small>
        </div>

        <!-- Email Field -->
        <div class="form-group">
          <label for="email">Email Address</label>
          <div style="position: relative;">
            <input
              id="email"
              type="email"
              class="form-control"
              formControlName="email"
              [disabled]="isSaving"
              placeholder="Enter your email address">
            <div *ngIf="checkingEmail()" style="position: absolute; right: 10px; top: 10px;">
              <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            </div>
          </div>
          <div class="error-message" *ngIf="hasError('email', 'required')">
            <small><i class="fas fa-exclamation-circle"></i> Email is required</small>
          </div>
          <div class="error-message" *ngIf="hasError('email', 'email')">
            <small><i class="fas fa-exclamation-circle"></i> Please enter a valid email address</small>
          </div>
          <div class="error-message" *ngIf="hasError('email', 'emailTaken')">
            <small><i class="fas fa-exclamation-circle"></i> ❌ This email is already registered</small>
          </div>
          <small class="text-success" *ngIf="!hasError('email', 'emailTaken') && !checkingEmail() && profileForm.get('email')?.valid && profileForm.get('email')?.touched && profileForm.get('email')?.value !== originalEmail">
            <i class="fas fa-check-circle"></i> ✅
          </small>
        </div>

        <!-- Age Field -->
        <div class="form-group">
          <label for="age">Age</label>
          <input
            id="age"
            type="number"
            class="form-control"
            formControlName="age"
            [disabled]="isSaving"
            min="1"
            max="120"
            placeholder="Enter your age">
          <div class="error-message" *ngIf="hasError('age', 'required')">
            <small><i class="fas fa-exclamation-circle"></i> Age is required</small>
          </div>
          <div class="error-message" *ngIf="hasError('age', 'min') || hasError('age', 'max')">
            <small><i class="fas fa-exclamation-circle"></i> Please enter a valid age (1-120)</small>
          </div>
        </div>

        <!-- Phone Number Field -->
        <div class="form-group">
          <label for="phoneNumber">Phone Number</label>
          <div style="position: relative;">
            <input
              id="phoneNumber"
              type="tel"
              class="form-control"
              formControlName="phoneNumber"
              [disabled]="isSaving"
              placeholder="Enter your phone number">
            <div *ngIf="checkingPhone()" style="position: absolute; right: 10px; top: 10px;">
              <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            </div>
          </div>
          <div class="error-message" *ngIf="hasError('phoneNumber', 'required')">
            <small><i class="fas fa-exclamation-circle"></i> Phone number is required</small>
          </div>
          <div class="error-message" *ngIf="hasError('phoneNumber', 'phoneTaken')">
            <small><i class="fas fa-exclamation-circle"></i> ❌ This phone number is already registered</small>
          </div>
          <small class="text-success" *ngIf="!hasError('phoneNumber', 'phoneTaken') && !checkingPhone() && profileForm.get('phoneNumber')?.valid && profileForm.get('phoneNumber')?.touched && profileForm.get('phoneNumber')?.value !== originalPhone">
            <i class="fas fa-check-circle"></i> ✅
          </small>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button
          type="submit"
          class="btn btn-success btn-lg"
          [disabled]="profileForm.invalid || isSaving">
          <span *ngIf="!isSaving">
            <i class="fas fa-save"></i> Save Changes
          </span>
          <span *ngIf="isSaving">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Saving...
          </span>
        </button>

        <button
          type="button"
          class="btn btn-outline-secondary btn-lg"
          (click)="resetForm()"
          [disabled]="isSaving">
          <i class="fas fa-redo"></i> Reset
        </button>
      </div>
    </form>
  </div>
</div>
