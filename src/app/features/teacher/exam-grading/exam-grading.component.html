<div class="exam-grading-container">
  <!-- Header -->
  <div class="page-header">
    <button class="back-btn" (click)="goBack()">
      <i class="fas fa-arrow-left"></i>
      Back
    </button>

    <div class="header-content">
      <h1>
        <i class="fas fa-clipboard-check"></i>
        {{ examTitle() || 'Exam Grading' }}
      </h1>
      <p>Student Submissions and Grading</p>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <button
      class="filter-btn"
      [class.active]="selectedFilter() === 'all'"
      (click)="selectedFilter.set('all')">
      All ({{ submissions().length }})
    </button>
    <button
      class="filter-btn"
      [class.active]="selectedFilter() === 'pending'"
      (click)="selectedFilter.set('pending')">
        Needs Grading ({{ pendingGradingCount() }})
    </button>
    <button
      class="filter-btn"
      [class.active]="selectedFilter() === 'manual'"
      (click)="selectedFilter.set('manual')">
        Manual Grading ({{ manualGradingCount() }})
    </button>
    <button
      class="filter-btn"
      [class.active]="selectedFilter() === 'graded'"
      (click)="selectedFilter.set('graded')">
        Graded ({{ gradedCount() }})
    </button>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper">
    <!-- Submissions List -->
    @if (!selectedSubmission()) {
      <div class="submissions-list">
        @for (submission of filteredSubmissions; track submission.studentExamId) {
          <div class="submission-card" (click)="viewSubmission(submission.studentExamId)">
            <div class="student-info">
              <div class="avatar">{{ submission.studentName[0] }}</div>
              <div class="details">
                <h4>{{ submission.studentName }}</h4>
                <span class="email">{{ submission.studentEmail }}</span>
              </div>
            </div>

            <div class="submission-meta">
              <span class="time">
                <i class="fas fa-clock"></i>
                {{ submission.submittedAt | date:'d MMM yyyy' }}
              </span>

              @if (submission.isGraded) {
                <div class="score-badge graded">
                  {{ submission.totalScore }} / {{ submission.totalMarks }}
                  <span class="percentage">({{ submission.scorePercentage }}%)</span>
                </div>
              } @else if (submission.autoGradedScore !== undefined) {
                <div class="score-badge auto">
                  {{ submission.autoGradedScore }} / {{ submission.totalMarks }}
                  <span class="note">Auto</span>
                </div>
              }

              @if (submission.pendingManualGrading) {
                <span class="badge warning">
                  <i class="fas fa-exclamation-circle"></i>
                  Needs Grading
                </span>
              }

              @if (submission.isGraded) {
                <span class="badge success">
                  <i class="fas fa-check-circle"></i>
                  Graded
                </span>
              }
            </div>

            <i class="fas fa-chevron-left arrow"></i>
          </div>
        } @empty {
          <div class="empty-state">
            <i class="fas fa-inbox fa-3x"></i>
            <p>No submissions found</p>
          </div>
        }
      </div>
    }

    <!-- Grading Detail View -->
    @if (selectedSubmission(); as submission) {
      <div class="grading-detail">
        <div class="detail-header">
          <button class="close-btn" (click)="closeDetailView()">
            <i class="fas fa-times"></i>
          </button>

          <div class="student-header">
            <h2>{{ submission.studentName }}</h2>
            <div class="submission-info">
              <span><i class="fas fa-calendar"></i> {{ submission.submittedAt | date:'d MMM yyyy' }}</span>
              <span><i class="fas fa-star"></i> {{ submission.totalMarks }} points</span>
            </div>
          </div>

          <div class="current-score">
            <span class="label">Current Score:</span>
            <span class="score">{{ getTotalScore() }} / {{ submission.totalMarks }}</span>
          </div>
        </div>

        <!-- Questions List -->
        <div class="questions-list">
          @for (question of submission.questions; track question.questionId) {
            <div class="question-card" [class.requires-grading]="question.requiresManualGrading">
              <div class="question-header">
                <span class="question-number">Question {{ $index + 1 }}</span>
                <span class="question-type">{{ getQuestionTypeLabel(question.questionType) }}</span>
                <span class="marks">{{ question.marks }} points</span>
              </div>

              <div class="question-text">{{ question.questionText }}</div>

              <!-- Student Answer -->
              <div class="answer-section">
                <label>Student Answer:</label>
                @if (question.questionType === QuestionType.Text) {
                  <div class="text-answer">{{ question.studentAnswer }}</div>
                } @else {
                  <div class="choices-answer">
                    @if (question.studentSelectedOptions && question.studentSelectedOptions.length > 0) {
                      <div class="selected-options">
                        @for (option of question.studentSelectedOptions; track option) {
                          <span class="option-badge">{{ option }}</span>
                        }
                      </div>
                    } @else if (question.studentAnswer) {
                      <span class="option-badge">{{ question.studentAnswer }}</span>
                    }
                  </div>
                }
              </div>

              <!-- Correct Answer (if auto-graded) -->
              @if (question.isCorrect !== null) {
                <div class="correct-answer">
                  <label>
                    <i class="fas" [ngClass]="question.isCorrect ? 'fa-check-circle success' : 'fa-times-circle error'"></i>
                    Correct Answer:
                  </label>
                  @if (question.correctOptions && question.correctOptions.length > 0) {
                    <div class="correct-options">
                      @for (option of question.correctOptions; track option) {
                        <span class="option-badge correct">{{ option }}</span>
                      }
                    </div>
                  } @else if (question.correctAnswer) {
                    <span class="option-badge correct">{{ question.correctAnswer }}</span>
                  }
                </div>
              }

              <!-- Manual Grading -->
              @if (question.requiresManualGrading) {
                <div class="grading-section">
                  <div class="score-input">
                    <label>Score:</label>
                    <input
                      type="number"
                      [max]="question.marks"
                      min="0"
                      [value]="questionGrades().get(question.questionId)?.score || 0"
                      (input)="updateQuestionScore(question.questionId, +$any($event.target).value)">
                    <span>/ {{ question.marks }}</span>
                  </div>

                  <div class="feedback-input">
                    <label>Feedback:</label>
                    <textarea
                      [value]="questionGrades().get(question.questionId)?.feedback || ''"
                      (input)="updateQuestionFeedback(question.questionId, $any($event.target).value)"
                      placeholder="Add feedback for the student..."
                      rows="3"></textarea>
                  </div>
                </div>
              } @else {
                <div class="auto-graded">
                  <i class="fas fa-robot"></i>
                  Auto-graded: {{ question.earnedScore }} / {{ question.marks }}
                </div>
              }
            </div>
          }
        </div>

        <!-- General Feedback -->
        <div class="general-feedback">
          <label>General Feedback:</label>
          <textarea
            [(ngModel)]="generalFeedback"
            placeholder="Add general feedback for the student..."
            rows="4"></textarea>
        </div>

        <!-- Submit Button -->
        <div class="actions">
          <button
            class="btn-submit"
            (click)="submitGrading()"
            [disabled]="grading()">
            @if (grading()) {
              <i class="fas fa-spinner fa-spin"></i>
              Saving...
            } @else {
              <i class="fas fa-check"></i>
              Save Grading
            }
          </button>
        </div>
      </div>
    }
  </div>
</div>
