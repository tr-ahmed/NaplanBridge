<main class="px-2 sm:px-4 lg:px-8 py-4 min-h-screen bg-gray-50">

  <!-- Page Header -->
  <div class="mb-6">
    <div class="bg-gradient-to-r from-teal-600 to-cyan-600 rounded-2xl shadow-xl p-6 text-white">
      <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="p-3 bg-white/20 backdrop-blur-lg rounded-xl">
            <i class="fas fa-chalkboard-teacher text-3xl"></i>
          </div>
          <div>
            <h1 class="text-3xl font-bold">Tutoring Management</h1>
            <p class="text-teal-100 text-sm mt-1">Manage your availability, sessions, and exceptions</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="mb-6">
    <div class="bg-white rounded-xl shadow-md p-2 inline-flex gap-2">
      <button (click)="switchTab('sessions')" [class]="activeTab() === 'sessions' 
          ? 'px-6 py-3 rounded-lg font-semibold bg-teal-600 text-white shadow-md transition-all' 
          : 'px-6 py-3 rounded-lg font-semibold text-gray-600 hover:bg-gray-100 transition-all'">
        <i class="fas fa-calendar-alt mr-2"></i>My Sessions
      </button>
      <button (click)="switchTab('availability')" [class]="activeTab() === 'availability' 
          ? 'px-6 py-3 rounded-lg font-semibold bg-teal-600 text-white shadow-md transition-all' 
          : 'px-6 py-3 rounded-lg font-semibold text-gray-600 hover:bg-gray-100 transition-all'">
        <i class="fas fa-clock mr-2"></i>Availability
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
  <div class="flex items-center justify-center py-20">
    <div class="text-center">
      <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-teal-600 mx-auto mb-4"></div>
      <p class="text-gray-600 text-lg">Loading...</p>
    </div>
  </div>
  }

  <!-- Sessions Tab -->
  @if (!loading() && activeTab() === 'sessions') {
  <div class="space-y-6">

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-blue-500">
        <div class="flex items-center gap-3">
          <div class="p-3 bg-blue-100 rounded-lg">
            <i class="fas fa-calendar-check text-blue-600 text-xl"></i>
          </div>
          <div>
            <p class="text-2xl font-bold text-gray-900">{{ getSessionStats().scheduled }}</p>
            <p class="text-sm text-gray-500">Scheduled</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-orange-500">
        <div class="flex items-center gap-3">
          <div class="p-3 bg-orange-100 rounded-lg">
            <i class="fas fa-play-circle text-orange-600 text-xl"></i>
          </div>
          <div>
            <p class="text-2xl font-bold text-gray-900">{{ getSessionStats().inProgress }}</p>
            <p class="text-sm text-gray-500">In Progress</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-green-500">
        <div class="flex items-center gap-3">
          <div class="p-3 bg-green-100 rounded-lg">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
          </div>
          <div>
            <p class="text-2xl font-bold text-gray-900">{{ getSessionStats().completed }}</p>
            <p class="text-sm text-gray-500">Completed</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Calendar Controls -->
    <div class="bg-white rounded-xl shadow-md p-4">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <!-- View Mode Selector -->
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-gray-600">View:</span>
          <div class="flex gap-1 bg-gray-100 rounded-lg p-1">
            <button (click)="setViewMode('today')"
              [class]="viewMode() === 'today' ? 'px-4 py-2 rounded-md bg-white shadow text-teal-600 font-semibold text-sm' : 'px-4 py-2 rounded-md text-gray-600 text-sm hover:bg-gray-200'">
              Today
            </button>
            <button (click)="setViewMode('day')"
              [class]="viewMode() === 'day' ? 'px-4 py-2 rounded-md bg-white shadow text-teal-600 font-semibold text-sm' : 'px-4 py-2 rounded-md text-gray-600 text-sm hover:bg-gray-200'">
              Day
            </button>
            <button (click)="setViewMode('week')"
              [class]="viewMode() === 'week' ? 'px-4 py-2 rounded-md bg-white shadow text-teal-600 font-semibold text-sm' : 'px-4 py-2 rounded-md text-gray-600 text-sm hover:bg-gray-200'">
              Week
            </button>
            <button (click)="setViewMode('all')"
              [class]="viewMode() === 'all' ? 'px-4 py-2 rounded-md bg-white shadow text-teal-600 font-semibold text-sm' : 'px-4 py-2 rounded-md text-gray-600 text-sm hover:bg-gray-200'">
              All
            </button>
          </div>
        </div>

        <!-- Date Navigation -->
        <div class="flex items-center gap-3">
          <button (click)="changeDate('prev')" class="p-2 rounded-lg hover:bg-gray-100">
            <i class="fas fa-chevron-left text-gray-600"></i>
          </button>

          @if (viewMode() !== 'week') {
          <input type="date" [value]="formatDateForInput(selectedDate())" (change)="setSelectedDate($event)"
            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
          } @else {
          <span class="px-4 py-2 font-medium text-gray-700">
            {{ formatDate(getWeekDates()[0]) }} - {{ formatDate(getWeekDates()[6]) }}
          </span>
          }

          <button (click)="changeDate('next')" class="p-2 rounded-lg hover:bg-gray-100">
            <i class="fas fa-chevron-right text-gray-600"></i>
          </button>

          @if (!isToday(selectedDate())) {
          <button (click)="goToToday()" class="px-4 py-2 text-sm font-medium text-teal-600 hover:bg-teal-50 rounded-lg">
            Go to Today
          </button>
          }

          <button (click)="refreshSessions()"
            class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 flex items-center gap-2">
            <i class="fas fa-sync-alt"></i>
            <span class="hidden sm:inline">Refresh</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Calendar View -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <!-- Week View -->
      @if (viewMode() === 'week') {
      <div class="grid grid-cols-7 gap-4">
        @for (date of getWeekDates(); track date) {
        <div class="min-h-[200px]">
          <div
            [class]="isToday(date) ? 'text-center p-2 bg-teal-600 text-white rounded-t-lg' : 'text-center p-2 bg-gray-100 rounded-t-lg'">
            <p class="font-semibold">{{ weekDays[date.getDay()] }}</p>
            <p class="text-sm">{{ date.getDate() }}</p>
          </div>
          <div class="border border-t-0 border-gray-200 rounded-b-lg p-2 min-h-[160px] bg-gray-50">
            @for (session of getSessionsForDate(date); track session.id) {
            <div class="mb-2 p-2 rounded-lg cursor-pointer transition-all hover:shadow-md" [class]="session.status === 'Scheduled' ? 'bg-blue-50 border-l-4 border-blue-500' : 
                               session.status === 'InProgress' ? 'bg-orange-50 border-l-4 border-orange-500' : 
                               session.status === 'Completed' ? 'bg-green-50 border-l-4 border-green-500' : 
                               'bg-gray-100 border-l-4 border-gray-400'">
              <div class="flex items-center justify-between">
                <span class="text-xs font-semibold text-gray-700">{{ session.startTime ||
                  formatTime(session.dateTime.toString()) }}</span>
                @if (session.meetingLink) {
                <button (click)="openMeetingLink(session); $event.stopPropagation()"
                  class="p-1 text-teal-600 hover:bg-teal-100 rounded" title="Join Meeting">
                  <i class="fas fa-video"></i>
                </button>
                }
              </div>
              <p class="text-xs text-gray-600 truncate">{{ session.studentName }}</p>
              <p class="text-xs text-gray-500 truncate">{{ session.subjectName }}</p>
            </div>
            }
            @if (getSessionsForDate(date).length === 0) {
            <p class="text-xs text-gray-400 text-center py-4">No sessions</p>
            }
          </div>
        </div>
        }
      </div>
      }

      <!-- Today/Day/All View -->
      @if (viewMode() !== 'week') {
      <div>
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
          @if (viewMode() === 'today') {
          Today's Sessions
          } @else if (viewMode() === 'all') {
          All Sessions ({{ filteredSessions().length }})
          } @else {
          Sessions for {{ formatDate(selectedDate()) }}
          }
        </h3>

        @if (filteredSessions().length === 0) {
        <div class="text-center py-12 bg-gray-50 rounded-xl">
          <i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i>
          <p class="text-gray-500">
            @if (viewMode() === 'all') {
            No sessions found
            } @else {
            No sessions for this date
            }
          </p>
        </div>
        }

        <div class="space-y-3">
          @for (session of filteredSessions(); track session.id) {
          <div class="flex items-center justify-between p-4 rounded-xl transition-all hover:shadow-md" [class]="session.status === 'Scheduled' ? 'bg-blue-50 border border-blue-200' : 
                           session.status === 'InProgress' ? 'bg-orange-50 border border-orange-200' : 
                           session.status === 'Completed' ? 'bg-green-50 border border-green-200' : 
                           'bg-gray-50 border border-gray-200'">
            <div class="flex items-center gap-4">
              <div class="text-center">
                <p class="text-lg font-bold text-gray-800">{{ session.startTime ||
                  formatTime(session.dateTime.toString()) }}</p>
                <p class="text-xs text-gray-500">{{ session.duration }} min</p>
              </div>
              <div class="h-12 w-px bg-gray-300"></div>
              <div>
                <p class="font-semibold text-gray-800">{{ session.studentName }}</p>
                <p class="text-sm text-gray-600">{{ session.subjectName }}</p>
              </div>
            </div>

            <div class="flex items-center gap-3">
              @if (session.meetingLink) {
              <button (click)="openMeetingLink(session)"
                class="p-2 text-teal-600 hover:bg-teal-100 rounded-lg transition-all" title="Join Meeting">
                <i class="fas fa-video text-lg"></i>
              </button>
              }

              <span class="px-3 py-1 rounded-full text-xs font-semibold" [class]="session.status === 'Scheduled' ? 'bg-blue-100 text-blue-700' : 
                               session.status === 'InProgress' ? 'bg-orange-100 text-orange-700' : 
                               session.status === 'Completed' ? 'bg-green-100 text-green-700' : 
                               'bg-gray-100 text-gray-700'">
                {{ session.status }}
              </span>

              <div class="flex gap-2">
                @if (session.status === 'Scheduled') {
                <button (click)="startSession(session)"
                  class="px-3 py-1 bg-teal-600 text-white text-sm rounded-lg hover:bg-teal-700">
                  Start
                </button>
                <button (click)="cancelSession(session)"
                  class="px-3 py-1 bg-red-100 text-red-600 text-sm rounded-lg hover:bg-red-200">
                  Cancel
                </button>
                }
                @if (session.status === 'InProgress') {
                <button (click)="completeSession(session)"
                  class="px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                  Complete
                </button>
                }

                <!-- Update Link Button -->
                <button (click)="openMeetingLinkDialog(session)"
                  class="px-3 py-1 bg-blue-100 text-blue-600 text-sm rounded-lg hover:bg-blue-200 flex items-center gap-1"
                  title="Update Meeting Link">
                  <i class="fas fa-link"></i>
                  <span class="hidden lg:inline">Link</span>
                </button>

                <!-- Add Notes Button -->
                <button (click)="openNotesDialog(session)"
                  class="px-3 py-1 bg-purple-100 text-purple-600 text-sm rounded-lg hover:bg-purple-200 flex items-center gap-1"
                  title="Add/Edit Notes">
                  <i class="fas fa-sticky-note"></i>
                  <span class="hidden lg:inline">Notes</span>
                </button>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>
  </div>
  }

  <!-- Availability Tab -->
  @if (!loading() && activeTab() === 'availability') {
  <div class="space-y-6">

    <!-- Teacher Profile Settings Card -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-xl font-bold text-gray-900">Profile Settings</h2>
          <p class="text-sm text-gray-500">Manage your visibility and profile</p>
        </div>
      </div>

      <!-- Welcome Message for New Teachers -->
      @if (!settings()) {
      <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-6 mb-6">
        <div class="flex items-start gap-4">
          <div class="p-3 bg-indigo-100 rounded-full">
            <i class="fas fa-hand-sparkles text-indigo-600 text-2xl"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-900 mb-2">
              ðŸ‘‹ Welcome to Your Teaching Dashboard!
            </h3>
            <p class="text-gray-700 mb-3">
              Set up your profile to start receiving bookings from students.
            </p>
          </div>
        </div>
      </div>
      }

      <!-- Simple Settings Form (Always Visible) -->
      <form [formGroup]="settingsForm" (ngSubmit)="saveSettings()" class="space-y-5">

        <!-- Accepting Bookings Toggle -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-200">
          <div class="flex items-center gap-3">
            <div class="p-2 rounded-lg"
              [class]="settingsForm.get('isAcceptingBookings')?.value ? 'bg-green-100' : 'bg-gray-200'">
              <i class="fas fa-calendar-check text-lg"
                [class]="settingsForm.get('isAcceptingBookings')?.value ? 'text-green-600' : 'text-gray-400'"></i>
            </div>
            <div>
              <p class="font-semibold text-gray-900">Accept Bookings</p>
              <p class="text-sm text-gray-500">Allow students to book sessions with you</p>
            </div>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" formControlName="isAcceptingBookings" class="sr-only peer">
            <div
              class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500">
            </div>
          </label>
        </div>

        <!-- Description -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-user-edit mr-1"></i>
            About Your Teaching
          </label>
          <textarea formControlName="description" rows="3"
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
            placeholder="Tell students about your teaching style, experience, and specializations..."></textarea>
          <p class="text-xs text-gray-400 mt-1">This will be shown to students when they browse available teachers.</p>
        </div>

        <!-- Save Button -->
        <div class="flex justify-end">
          <button type="submit" [disabled]="savingSettings()"
            class="px-6 py-2.5 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 transition-all flex items-center gap-2">
            @if (savingSettings()) {
            <i class="fas fa-spinner fa-spin"></i>
            <span>Saving...</span>
            } @else {
            <i class="fas fa-save"></i>
            <span>Save Profile</span>
            }
          </button>
        </div>
      </form>
    </div>


    <!-- Time Slots Card -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-xl font-bold text-gray-900">Available Time Slots</h2>
          <p class="text-sm text-gray-500">Manage your weekly availability</p>
        </div>
        <div class="flex items-center gap-2">
          <button (click)="refreshAvailabilities()"
            class="px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-all flex items-center gap-2">
            <i class="fas fa-sync-alt"></i>
            <span class="hidden sm:inline">Refresh</span>
          </button>
          <button (click)="toggleAvailabilityForm()"
            class="px-5 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-all flex items-center gap-2">
            @if (!showAvailabilityForm()) {
            <i class="fas fa-plus"></i>
            }
            {{ showAvailabilityForm() ? 'Cancel' : 'Add Time Slot' }}
          </button>
        </div>
      </div>

      <!-- Add Availability Form -->
      @if (showAvailabilityForm()) {
      <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 p-6 rounded-xl mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900">
            {{ showSlotGenerator() ? 'âœ¨ Bulk Slot Generator' : 'Add New Time Slot' }}
          </h3>

          <!-- Mode Toggle Button - More Prominent -->
          <button (click)="toggleSlotGenerator()"
            class="flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all"
            [class]="showSlotGenerator() 
                    ? 'bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-300' 
                    : 'bg-gradient-to-r from-purple-500 to-indigo-500 text-white hover:from-purple-600 hover:to-indigo-600 shadow-md'">
            @if (showSlotGenerator()) {
            <i class="fas fa-clock"></i>
            <span>Simple Mode</span>
            } @else {
            <i class="fas fa-magic"></i>
            <span>Bulk Generator</span>
            <span class="bg-white/20 text-xs px-1.5 py-0.5 rounded">PRO</span>
            }
          </button>
        </div>

        <!-- Simple Mode -->
        @if (!showSlotGenerator()) {
        <form [formGroup]="availabilityForm" (ngSubmit)="addAvailability()">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Day</label>
              <select formControlName="dayOfWeek"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                <option value="">Select Day</option>
                @for (day of daysOfWeek; track day.value) {
                <option [value]="day.value">{{ day.label }}</option>
                }
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
              <input type="time" formControlName="startTime"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
              <input type="time" formControlName="endTime"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
            </div>
          </div>
          <div class="flex gap-3">
            <button type="submit" [disabled]="addingAvailability() || availabilityForm.invalid"
              class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400">
              {{ addingAvailability() ? 'Adding...' : 'Add Time Slot' }}
            </button>
            <button type="button" (click)="toggleAvailabilityForm()"
              class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
              Cancel
            </button>
          </div>
        </form>
        }

        <!-- Slot Generator Mode -->
        @if (showSlotGenerator()) {
        <form [formGroup]="slotGeneratorForm" (ngSubmit)="generateSlots()">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Day</label>
              <select formControlName="dayOfWeek"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                <option value="">Select Day</option>
                @for (day of daysOfWeek; track day.value) {
                <option [value]="day.value">{{ day.label }}</option>
                }
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
              <input type="time" formControlName="startTime"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
              <input type="time" formControlName="endTime"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Session Duration (min)</label>
              <input type="number" formControlName="sessionDuration"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" min="15"
                max="180">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Break Between (min)</label>
              <input type="number" formControlName="breakBetweenSessions"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" min="0"
                max="60">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Session Type</label>
              <select formControlName="defaultSessionType"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                <option value="OneToOne">One-to-One</option>
                <option value="Group">Group</option>
                <option value="BookingFirst">Flexible (Student Chooses)</option>
              </select>
            </div>

            <!-- Max Students - Only for Group Sessions -->
            @if (slotGeneratorForm.get('defaultSessionType')?.value === 'Group') {
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Max Students <span class="text-red-500">*</span>
              </label>
              <input type="number" formControlName="maxStudents"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" min="2"
                max="10" placeholder="2-10">
              <p class="text-xs text-gray-400 mt-1">Required for group sessions (2-10 students)</p>
            </div>
            }
          </div>
          <div class="flex gap-3">
            <button type="submit" [disabled]="addingAvailability() || slotGeneratorForm.invalid"
              class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:bg-gray-400 flex items-center gap-2">
              <i class="fas fa-magic"></i>
              {{ addingAvailability() ? 'Generating...' : 'Generate Slots' }}
            </button>
            <button type="button" (click)="toggleAvailabilityForm()"
              class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
              Cancel
            </button>
          </div>
        </form>
        }
      </div>
      }

      <!-- Availabilities List - Grouped by Day with Cards Grid -->
      @if (availabilities().length > 0) {
      <div class="space-y-4">
        @for (day of getSortedDays(); track day) {
        <div class="bg-gray-50 border border-gray-200 rounded-xl overflow-hidden">
          <!-- Day Header -->
          <div class="bg-gradient-to-r from-indigo-500 to-purple-500 px-4 py-2 flex items-center gap-2">
            <i class="fas fa-calendar-day text-white"></i>
            <span class="font-bold text-white">{{ day }}</span>
            <span class="text-indigo-200 text-sm">({{ getAvailabilitiesByDay()[day].length }})</span>
          </div>

          <!-- Slots Grid - Compact -->
          <div class="p-3 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-2">
            @for (availability of getAvailabilitiesByDay()[day]; track availability.id)
            {
            <div
              class="group relative bg-white rounded-lg border border-gray-200 overflow-hidden hover:shadow-md hover:border-indigo-300 transition-all cursor-pointer"
              (click)="editAvailability(availability)">

              <!-- Delete Button - Always Visible -->
              <button (click)="deleteAvailability(availability); $event.stopPropagation()"
                class="absolute top-0 right-0 p-1 bg-red-500 text-white hover:bg-red-600 transition-all z-10"
                title="Delete">
                <i class="fas fa-times text-[10px]"></i>
              </button>

              <!-- Time Header - Larger -->
              <div class="px-3 py-2 text-center font-bold text-white" [class]="availability.sessionType === 'OneToOne' ? 'bg-blue-500' : 
                            availability.sessionType === 'Group' ? 'bg-purple-500' : 
                            'bg-teal-500'">
                <span class="text-sm">{{ formatTime(availability.startTime) }}</span>
              </div>

              <!-- Session Info - Single Row -->
              <div class="flex items-center justify-center gap-1.5 px-2 py-1.5 text-xs" [class]="availability.sessionType === 'OneToOne' ? 'text-blue-600' : 
                            availability.sessionType === 'Group' ? 'text-purple-600' : 
                            'text-teal-600'">
                <i [class]="availability.sessionType === 'OneToOne' ? 'fas fa-user' : 
                            availability.sessionType === 'Group' ? 'fas fa-users' : 
                            'fas fa-random'"></i>
                <span class="font-medium">{{ availability.sessionType === 'OneToOne' ? '1:1' :
                  availability.sessionType === 'Group' ? 'Grp' : 'Flex' }}</span>
                @if (availability.sessionType === 'Group' && availability.maxStudents) {
                <span class="text-gray-400">â€¢</span>
                <span class="text-gray-500">{{ availability.maxStudents }}</span>
                }
              </div>
            </div>
            }
          </div>
        </div>
        }
      </div>
      }




      <!-- Empty State -->
      @if (availabilities().length === 0) {
      <div class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
        <i class="fas fa-calendar-plus text-4xl text-gray-300 mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-700 mb-2">No time slots yet</h3>
        <p class="text-gray-500 mb-4">Add your available times for private sessions</p>
        <button (click)="toggleAvailabilityForm()"
          class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
          <i class="fas fa-plus mr-2"></i>Add Your First Time Slot
        </button>
      </div>
      }
    </div>

    <!-- Exception Days Card -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-xl font-bold text-gray-900">Exception Days</h2>
          <p class="text-sm text-gray-500">Mark days when you're unavailable (holidays, time off)</p>
        </div>
        <button (click)="toggleExceptionForm()"
          class="px-5 py-2 bg-amber-600 text-white font-medium rounded-lg hover:bg-amber-700 transition-all flex items-center gap-2">
          @if (!showExceptionForm()) {
          <i class="fas fa-plus"></i>
          }
          {{ showExceptionForm() ? 'Cancel' : 'Add Exception' }}
        </button>
      </div>

      <!-- Add Exception Form -->
      @if (showExceptionForm()) {
      <form [formGroup]="exceptionForm" (ngSubmit)="addException()"
        class="bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-200 p-6 rounded-xl mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Add Exception Day</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
            <input type="date" formControlName="startDate"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">End Date (Optional)</label>
            <input type="date" formControlName="endDate"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Optional)</label>
            <input type="text" formControlName="reason" placeholder="e.g., Holiday"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
          </div>
        </div>
        <div class="flex gap-3">
          <button type="submit" [disabled]="addingException() || exceptionForm.invalid"
            class="px-6 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:bg-gray-400">
            {{ addingException() ? 'Adding...' : 'Add Exception' }}
          </button>
          <button type="button" (click)="toggleExceptionForm()"
            class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
        </div>
      </form>
      }

      <!-- Exceptions List -->
      @if (exceptions().length > 0) {
      <div class="space-y-3">
        @for (exception of exceptions(); track exception.id) {
        <div class="flex items-center justify-between bg-amber-50 border border-amber-200 p-4 rounded-lg">
          <div class="flex items-center gap-4">
            <i class="fas fa-calendar-times text-amber-600 text-xl"></i>
            <div>
              <p class="font-semibold text-gray-800">
                @if (exception.startDate === exception.endDate) {
                {{ formatExceptionDate(exception.startDate) }}
                } @else {
                {{ formatExceptionDate(exception.startDate) }} â†’ {{ formatExceptionDate(exception.endDate) }}
                }
              </p>
              @if (exception.reason) {
              <p class="text-sm text-gray-600">{{ exception.reason }}</p>
              }
            </div>
          </div>
          <button (click)="deleteException(exception)"
            class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-all">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
        }
      </div>
      }

      <!-- Empty State -->
      @if (exceptions().length === 0 && !showExceptionForm()) {
      <div class="text-center py-8 bg-gray-50 rounded-xl">
        <i class="fas fa-umbrella-beach text-3xl text-gray-300 mb-3"></i>
        <p class="text-gray-500">No exception days added</p>
      </div>
      }
    </div>

  </div>
  }

</main>

<!-- Edit Slot Modal -->
@if (showEditSlotModal() && editingSlot()) {
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
  (click)="closeEditSlotModal()">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-teal-600 to-cyan-600 p-6 text-white">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-white/20 rounded-lg">
            <i class="fas fa-edit text-xl"></i>
          </div>
          <div>
            <h3 class="text-xl font-bold">Edit Time Slot</h3>
            <p class="text-sm text-teal-100">{{ getDayName(editingSlot()!.dayOfWeek) }} â€¢ {{
              formatTime(editingSlot()!.startTime) }} - {{ formatTime(editingSlot()!.endTime) }}</p>
          </div>
        </div>
        <button (click)="closeEditSlotModal()" class="p-2 hover:bg-white/20 rounded-lg transition-all">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
      <div class="space-y-4">
        <!-- Session Type Selection -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-3">Session Type</label>
          <div class="grid grid-cols-3 gap-3">
            <button (click)="updateSlotSessionType('OneToOne')" [disabled]="updatingSlot()"
              class="p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2" [class]="editingSlot()!.sessionType === 'OneToOne' 
                ? 'border-blue-500 bg-blue-50 text-blue-700' 
                : 'border-gray-200 hover:border-blue-300 hover:bg-blue-50'">
              <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                <i class="fas fa-user text-blue-600 text-xl"></i>
              </div>
              <span class="font-semibold">1-on-1</span>
              <span class="text-xs text-gray-500 text-center">Private session</span>
            </button>
            <button (click)="updateSlotSessionType('Group', 5)" [disabled]="updatingSlot()"
              class="p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2" [class]="editingSlot()!.sessionType === 'Group' 
                ? 'border-purple-500 bg-purple-50 text-purple-700' 
                : 'border-gray-200 hover:border-purple-300 hover:bg-purple-50'">
              <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                <i class="fas fa-users text-purple-600 text-xl"></i>
              </div>
              <span class="font-semibold">Group</span>
              <span class="text-xs text-gray-500 text-center">Multiple students</span>
            </button>
            <button (click)="updateSlotSessionType('BookingFirst')" [disabled]="updatingSlot()"
              class="p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2" [class]="editingSlot()!.sessionType === 'BookingFirst' 
                ? 'border-teal-500 bg-teal-50 text-teal-700' 
                : 'border-gray-200 hover:border-teal-300 hover:bg-teal-50'">
              <div class="w-12 h-12 rounded-full bg-teal-100 flex items-center justify-center">
                <i class="fas fa-hand-pointer text-teal-600 text-xl"></i>
              </div>
              <span class="font-semibold">Flexible</span>
              <span class="text-xs text-gray-500 text-center">Student chooses</span>
            </button>
          </div>
        </div>

        <!-- Loading State -->
        @if (updatingSlot()) {
        <div class="flex items-center justify-center py-4">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600"></div>
          <span class="ml-3 text-gray-600">Updating...</span>
        </div>
        }
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="bg-gray-50 px-6 py-4 flex justify-end">
      <button (click)="closeEditSlotModal()"
        class="px-6 py-2 text-gray-700 hover:bg-gray-200 rounded-lg font-medium transition-all">
        Cancel
      </button>
    </div>
  </div>
</div>
}

<!-- Meeting Link Modal -->
@if (showMeetingLinkModal() && meetingLinkSession()) {
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
  (click)="closeMeetingLinkModal()">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-white/20 rounded-lg">
            <i class="fas fa-link text-xl"></i>
          </div>
          <div>
            <h3 class="text-xl font-bold">Update Meeting Link</h3>
            <p class="text-sm text-blue-100">{{ meetingLinkSession()!.studentName }} - {{
              meetingLinkSession()!.subjectName }}</p>
          </div>
        </div>
        <button (click)="closeMeetingLinkModal()" class="p-2 hover:bg-white/20 rounded-lg transition-all">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Meeting Link (Google Meet, Zoom, etc.)</label>
          <input type="url" [(ngModel)]="meetingLinkInput" placeholder="https://meet.google.com/xxx-yyyy-zzz"
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-gray-900">
          <p class="text-xs text-gray-500 mt-2">
            <i class="fas fa-info-circle mr-1"></i>
            Paste your meeting link here. Students will use this to join the session.
          </p>
        </div>

        @if (meetingLinkSession()!.meetingLink) {
        <div class="bg-gray-50 rounded-lg p-3">
          <p class="text-xs text-gray-600 font-medium mb-1">Current Link:</p>
          <a [href]="meetingLinkSession()!.meetingLink" target="_blank"
            class="text-blue-600 hover:underline text-sm break-all">
            {{ meetingLinkSession()!.meetingLink }}
          </a>
        </div>
        }
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
      <button (click)="closeMeetingLinkModal()"
        class="px-6 py-2 text-gray-700 hover:bg-gray-200 rounded-lg font-medium transition-all">
        Cancel
      </button>
      <button (click)="saveMeetingLink()" [disabled]="updatingMeetingLink() || !meetingLinkInput.trim()"
        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 font-medium transition-all flex items-center gap-2">
        @if (updatingMeetingLink()) {
        <i class="fas fa-spinner fa-spin"></i>
        <span>Saving...</span>
        } @else {
        <i class="fas fa-save"></i>
        <span>Save Link</span>
        }
      </button>
    </div>
  </div>
</div>
}

<!-- Notes Modal -->
@if (showNotesModal() && notesSession()) {
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
  (click)="closeNotesModal()">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-white/20 rounded-lg">
            <i class="fas fa-sticky-note text-xl"></i>
          </div>
          <div>
            <h3 class="text-xl font-bold">Session Notes</h3>
            <p class="text-sm text-purple-100">{{ notesSession()!.studentName }} - {{ notesSession()!.subjectName }}</p>
          </div>
        </div>
        <button (click)="closeNotesModal()" class="p-2 hover:bg-white/20 rounded-lg transition-all">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
          <textarea [(ngModel)]="notesInput" rows="5"
            placeholder="Add notes about this session, topics covered, homework assigned, student progress..."
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all text-gray-900 resize-none"></textarea>
          <p class="text-xs text-gray-500 mt-2">
            <i class="fas fa-info-circle mr-1"></i>
            These notes are visible to you and can help track student progress.
          </p>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
      <button (click)="closeNotesModal()"
        class="px-6 py-2 text-gray-700 hover:bg-gray-200 rounded-lg font-medium transition-all">
        Cancel
      </button>
      <button (click)="saveNotes()" [disabled]="updatingNotes()"
        class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 font-medium transition-all flex items-center gap-2">
        @if (updatingNotes()) {
        <i class="fas fa-spinner fa-spin"></i>
        <span>Saving...</span>
        } @else {
        <i class="fas fa-save"></i>
        <span>Save Notes</span>
        }
      </button>
    </div>
  </div>
</div>
}