<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-6xl mx-auto px-4">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">üìö Select Your Learning Package</h1>
      <p class="text-gray-600">Choose subjects, teaching type, and students to get started</p>
    </div>

    <!-- Stepper -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between">
        <!-- Step 1 -->
        <div class="flex items-center flex-1">
          <div
            [class]="currentStep >= 1 ? 'bg-primary text-white' : 'bg-gray-300 text-gray-600'"
            class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg transition-all"
          >
            1
          </div>
          <div class="ml-3 flex-1">
            <h3 class="font-semibold text-gray-800">Teaching & Subjects</h3>
            <p class="text-sm text-gray-500">Choose type and subjects</p>
          </div>
        </div>

        <div class="w-16 h-1 bg-gray-300 mx-2" [class.bg-primary]="currentStep > 1"></div>

        <!-- Step 2 -->
        <div class="flex items-center flex-1">
          <div
            [class]="currentStep >= 2 ? 'bg-primary text-white' : 'bg-gray-300 text-gray-600'"
            class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg transition-all"
          >
            2
          </div>
          <div class="ml-3 flex-1">
            <h3 class="font-semibold text-gray-800">Select Students</h3>
            <p class="text-sm text-gray-500">Choose your students</p>
          </div>
        </div>

        <div class="w-16 h-1 bg-gray-300 mx-2" [class.bg-primary]="currentStep > 2"></div>

        <!-- Step 3 -->
        <div class="flex items-center flex-1">
          <div
            [class]="currentStep >= 3 ? 'bg-primary text-white' : 'bg-gray-300 text-gray-600'"
            class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg transition-all"
          >
            3
          </div>
          <div class="ml-3 flex-1">
            <h3 class="font-semibold text-gray-800">Review & Pay</h3>
            <p class="text-sm text-gray-500">Confirm and checkout</p>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <!-- Step 1: Teaching Type & Subjects -->
        <div *ngIf="currentStep === 1" class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">1Ô∏è‚É£ Choose Teaching Type & Subjects</h2>

          <!-- Term Selection -->
          <div class="mb-8">
            <label class="block text-lg font-semibold text-gray-700 mb-3">Academic Term</label>
            <select
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              [ngModel]="selectedTermId"
              (ngModelChange)="onTermChange($event)"
            >
              <option [ngValue]="null" disabled>Select term</option>
              <option *ngFor="let t of terms" [ngValue]="t.id">{{ t.name }} ({{ t.startDate | date:'MMM d' }} - {{ t.endDate | date:'MMM d, y' }})</option>
            </select>
            <p class="text-sm text-gray-500 mt-2">üìå Each student will be enrolled in subjects for their registered year level</p>
          </div>

          <!-- Teaching Type Selection -->
          <div class="mb-8">
            <label class="block text-lg font-semibold text-gray-700 mb-3">Teaching Type</label>
            <div class="grid grid-cols-2 gap-4">
              <button
                (click)="selectTeachingType(TeachingType.OneToOne)"
                [class]="teachingType === TeachingType.OneToOne
                  ? 'bg-primary text-white border-primary'
                  : 'bg-white text-gray-700 border-gray-300 hover:border-primary'"
                class="p-6 rounded-xl border-2 transition-all text-center"
              >
                <div class="text-4xl mb-2">üë§</div>
                <h3 class="font-bold text-lg">One-to-One</h3>
                <p class="text-sm mt-1 opacity-80">Private tutoring for 1 student</p>
              </button>

              <button
                (click)="selectTeachingType(TeachingType.GroupTutoring)"
                [class]="teachingType === TeachingType.GroupTutoring
                  ? 'bg-accent text-white border-accent'
                  : 'bg-white text-gray-700 border-gray-300 hover:border-accent'"
                class="p-6 rounded-xl border-2 transition-all text-center"
              >
                <div class="text-4xl mb-2">üë•</div>
                <h3 class="font-bold text-lg">Group Tutoring</h3>
                <p class="text-sm mt-1 opacity-80">Group learning (2-4 students)</p>
              </button>
            </div>
          </div>

          <!-- Student Count (for Group Tutoring) -->
          <div *ngIf="teachingType === TeachingType.GroupTutoring" class="mb-8">
            <label class="block text-lg font-semibold text-gray-700 mb-3">Number of Students</label>
            <div class="flex gap-3">
              <button
                *ngFor="let count of [2, 3, 4]"
                (click)="updateStudentCount(count)"
                [class]="studentCount === count
                  ? 'bg-accent text-white border-accent'
                  : 'bg-white text-gray-700 border-gray-300 hover:border-accent'"
                class="px-6 py-3 rounded-lg border-2 font-semibold transition-all"
              >
                {{ count }} Students
              </button>
            </div>
          </div>

          <!-- Subject Selection -->
          <div>
            <label class="block text-lg font-semibold text-gray-700 mb-3">Select Subjects</label>
            <div *ngIf="loading" class="text-center py-8">
              <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent"></div>
              <p class="mt-3 text-gray-600">Loading subjects...</p>
            </div>

            <div *ngIf="!loading" class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <button
                *ngFor="let subject of availableSubjects"
                (click)="toggleSubject(subject.name)"
                [class]="isSubjectSelected(subject.name)
                  ? 'bg-primary text-white border-primary'
                  : 'bg-white text-gray-700 border-gray-300 hover:border-primary'"
                class="p-4 rounded-xl border-2 transition-all text-left"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <h3 class="font-bold text-lg">{{ subject.name }}</h3>
                    <p class="text-sm mt-1 opacity-80">{{ subject.arabicName }}</p>
                    <p class="text-xs mt-1 opacity-70">Available for all year levels</p>
                  </div>
                  <div *ngIf="isSubjectSelected(subject.name)" class="text-2xl">‚úì</div>
                </div>
              </button>
            </div>

            <div *ngIf="!loading && availableSubjects.length === 0" class="text-center py-8 text-gray-500">
              No subjects available at the moment.
            </div>
          </div>

          <!-- Navigation -->
          <div class="flex justify-end mt-8">
            <button
              (click)="nextStep()"
              [disabled]="!canProceedToStep2() || isNextDisabled()"
              class="bg-primary hover:bg-primary/90 disabled:bg-gray-300 text-white px-8 py-3 rounded-xl font-semibold transition-all flex items-center gap-2"
            >
              <span>Next: Select Students</span>
              <span>‚Üí</span>
            </button>
          </div>
        </div>

        <!-- Step 2: Student Selection -->
        <div *ngIf="currentStep === 2" class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">2Ô∏è‚É£ Select Students</h2>

          <p class="text-gray-600 mb-6">
            Please select <strong>{{ studentCount }}</strong> student{{ studentCount > 1 ? 's' : '' }} for this package.
            <span class="text-sm">({{ selectedStudentIds.length }}/{{ studentCount }} selected)</span>
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button
              *ngFor="let student of availableStudents"
              (click)="toggleStudent(student.id)"
              [disabled]="!isStudentSelected(student.id) && selectedStudentIds.length >= studentCount"
              [class]="isStudentSelected(student.id)
                ? 'bg-primary text-white border-primary'
                : 'bg-white text-gray-700 border-gray-300 hover:border-primary disabled:opacity-50 disabled:cursor-not-allowed'"
              class="p-5 rounded-xl border-2 transition-all text-left"
            >
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-bold text-lg">{{ student.userName }}</h3>
                  <p class="text-sm mt-1 opacity-80">{{ student.email }}</p>
                  <p class="text-xs mt-1 opacity-70">Year {{ student.year }} ‚Ä¢ Age {{ student.age }}</p>
                </div>
                <div *ngIf="isStudentSelected(student.id)" class="text-2xl">‚úì</div>
              </div>
            </button>
          </div>

          <div *ngIf="availableStudents.length === 0" class="text-center py-12">
            <p class="text-gray-500 text-lg mb-4">No students found.</p>
            <button (click)="addStudent()" class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-xl font-semibold">
              + Add Student
            </button>
          </div>

          <!-- Navigation -->
          <div class="flex justify-between mt-8">
            <button
              (click)="previousStep()"
              class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-8 py-3 rounded-xl font-semibold transition-all flex items-center gap-2"
            >
              <span>‚Üê</span>
              <span>Back</span>
            </button>
            <button
              (click)="nextStep()"
              [disabled]="!canProceedToStep3() || isNextDisabled()"
              class="bg-primary hover:bg-primary/90 disabled:bg-gray-300 text-white px-8 py-3 rounded-xl font-semibold transition-all flex items-center gap-2"
            >
              <span>Next: Review Order</span>
              <span>‚Üí</span>
            </button>
          </div>
        </div>

        <!-- Step 3: Review & Checkout -->
        <div *ngIf="currentStep === 3" class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">3Ô∏è‚É£ Review Your Order</h2>

          <!-- Teaching Type -->
          <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-semibold text-gray-700 mb-2">Teaching Type</h3>
            <p class="text-lg">
              {{ teachingType === TeachingType.OneToOne ? 'üë§ One-to-One Tutoring' : 'üë• Group Tutoring' }}
            </p>
          </div>

          <!-- Selected Subjects -->
          <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-semibold text-gray-700 mb-3">Selected Subjects</h3>
            <div class="flex flex-wrap gap-2">
              <span
                *ngFor="let subject of getSelectedSubjects()"
                class="px-4 py-2 bg-primary text-white rounded-lg font-semibold"
              >
                {{ subject.name }}
              </span>
            </div>
          </div>

          <!-- Selected Students -->
          <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-semibold text-gray-700 mb-3">Selected Students ({{ selectedStudentIds.length }})</h3>
            <div class="space-y-2">
              <div
                *ngFor="let student of getSelectedStudents()"
                class="flex items-center gap-3 p-3 bg-white rounded-lg"
              >
                <div class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center font-bold">
                  {{ student.userName.charAt(0) }}
                </div>
                <div>
                  <p class="font-semibold">{{ student.userName }}</p>
                  <p class="text-sm text-gray-600">{{ student.email }} ‚Ä¢ Year {{ student.year }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Price Breakdown -->
          <div *ngIf="priceCalculation" class="mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-lg">
            <h3 class="font-semibold text-gray-700 mb-3">Price Breakdown</h3>
            <div class="space-y-2">
              <div class="flex justify-between text-gray-700">
                <span>Package Price:</span>
                <span class="font-semibold">${{ getTotalPrice().toFixed(2) }}</span>
              </div>
              <div class="flex justify-between text-gray-600 text-sm">
                <span>Price per student:</span>
                <span>${{ getPricePerStudent().toFixed(2) }}</span>
              </div>
              <div *ngIf="priceCalculation.priceBreakdown" class="pt-2 border-t border-green-300 text-sm text-gray-600">
                {{ priceCalculation.priceBreakdown }}
              </div>
              <div *ngIf="priceCalculation.breakdown && priceCalculation.breakdown.length > 0" class="pt-2 border-t border-green-300">
                <p class="text-sm text-gray-600 mb-2">Individual Subject Prices:</p>
                <div *ngFor="let item of priceCalculation.breakdown" class="flex justify-between text-sm text-gray-600">
                  <span>{{ item.subjectName }}:</span>
                  <span>${{ item.price.toFixed(2) }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Navigation -->
          <div class="flex justify-between mt-8">
            <button
              (click)="previousStep()"
              class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-8 py-3 rounded-xl font-semibold transition-all flex items-center gap-2"
            >
              <span>‚Üê</span>
              <span>Back</span>
            </button>
            <button
              (click)="proceedToCheckout()"
              [disabled]="creatingOrder"
              class="bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white px-8 py-3 rounded-xl font-semibold transition-all flex items-center gap-2"
            >
              <span *ngIf="creatingOrder" class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></span>
              <span>{{ creatingOrder ? 'Processing...' : 'üí≥ Proceed to Payment' }}</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Sidebar: Price Summary (Always Visible) -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üí∞ Price Summary</h3>

          <div *ngIf="!priceCalculation || selectedSubjectIds.length === 0" class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-3">üì¶</div>
            <p>Select subjects to see pricing</p>
          </div>

          <div *ngIf="calculatingPrice" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent"></div>
            <p class="mt-3 text-gray-600">Calculating...</p>
          </div>

          <div *ngIf="priceCalculation && !calculatingPrice">
            <!-- Package Name -->
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
              <p class="text-sm text-gray-600 mb-1">Package</p>
              <p class="font-bold text-lg">{{ priceCalculation.packageName || priceCalculation.message || 'Custom Package' }}</p>
            </div>

            <!-- Teaching Type -->
            <div class="mb-4">
              <div class="flex justify-between text-gray-700 mb-2">
                <span>Teaching Type:</span>
                <span class="font-semibold">{{ teachingType === TeachingType.OneToOne ? 'One-to-One' : 'Group' }}</span>
              </div>
              <div class="flex justify-between text-gray-700">
                <span>Students:</span>
                <span class="font-semibold">{{ studentCount }}</span>
              </div>
            </div>

            <!-- Divider -->
            <div class="border-t border-gray-200 my-4"></div>

            <!-- Selected Subjects -->
            <div class="mb-4">
              <p class="text-sm text-gray-600 mb-2">Subjects ({{ selectedSubjectNames.length }}):</p>
              <div class="space-y-1">
                <div *ngFor="let subject of getSelectedSubjects()" class="text-sm text-gray-700">
                  ‚Ä¢ {{ subject.name }}
                </div>
              </div>
            </div>

            <!-- Divider -->
            <div class="border-t border-gray-200 my-4"></div>

            <!-- Total Price -->
            <div class="bg-primary text-white p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="text-lg">Total Price:</span>
                <span class="text-3xl font-bold">${{ getTotalPrice().toFixed(2) }}</span>
              </div>
              <div class="text-sm opacity-90">
                ${{ getPricePerStudent().toFixed(2) }} per student
              </div>
            </div>

            <!-- Pricing Info -->
            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <p class="text-xs text-gray-600">
                <span class="font-semibold">{{ priceCalculation.usedIndividualPricing ? 'üìä Calculated Pricing' : '‚úÖ Package Pricing' }}</span>
              </p>
              <p class="text-xs text-gray-600 mt-1">
                {{ priceCalculation.usedIndividualPricing
                  ? 'Price calculated from individual subjects'
                  : 'Special package rate applied' }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
