<!-- Advanced Analytics Dashboard -->
<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- Header -->
    <div class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Advanced Analytics</h1>
        <p class="mt-1 text-sm text-gray-600">Comprehensive insights and reports</p>
      </div>

      <div class="flex gap-3">
        <button
          (click)="refresh()"
          class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
          <span class="text-lg">🔄</span>
          <span>Refresh</span>
        </button>
        <button
          (click)="exportToPDF()"
          [disabled]="!analyticsData()"
          class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2 disabled:opacity-50">
          <span class="text-lg">📄</span>
          <span>PDF</span>
        </button>
        <button
          (click)="exportToExcel()"
          [disabled]="!analyticsData()"
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 disabled:opacity-50">
          <span class="text-lg">📊</span>
          <span>Excel</span>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    @if (loading()) {
      <div class="flex justify-center items-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
      </div>
    }

    <!-- Content -->
    @if (!loading() && analyticsData()) {

      <!-- Period Selector -->
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex flex-wrap gap-2">
          <button
            (click)="changePeriod('week')"
            [class.bg-indigo-600]="selectedPeriod() === 'week'"
            [class.text-white]="selectedPeriod() === 'week'"
            [class.bg-gray-100]="selectedPeriod() !== 'week'"
            [class.text-gray-700]="selectedPeriod() !== 'week'"
            class="px-4 py-2 rounded-lg transition-colors font-medium">
            This Week
          </button>
          <button
            (click)="changePeriod('month')"
            [class.bg-indigo-600]="selectedPeriod() === 'month'"
            [class.text-white]="selectedPeriod() === 'month'"
            [class.bg-gray-100]="selectedPeriod() !== 'month'"
            [class.text-gray-700]="selectedPeriod() !== 'month'"
            class="px-4 py-2 rounded-lg transition-colors font-medium">
            This Month
          </button>
          <button
            (click)="changePeriod('year')"
            [class.bg-indigo-600]="selectedPeriod() === 'year'"
            [class.text-white]="selectedPeriod() === 'year'"
            [class.bg-gray-100]="selectedPeriod() !== 'year'"
            [class.text-gray-700]="selectedPeriod() !== 'year'"
            class="px-4 py-2 rounded-lg transition-colors font-medium">
            This Year
          </button>
        </div>
      </div>

      <!-- Report Type Tabs -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="border-b border-gray-200">
          <nav class="flex flex-wrap -mb-px">
            <button
              (click)="changeReport('overview')"
              [class.border-indigo-500]="selectedReport() === 'overview'"
              [class.text-indigo-600]="selectedReport() === 'overview'"
              [class.border-transparent]="selectedReport() !== 'overview'"
              [class.text-gray-500]="selectedReport() !== 'overview'"
              class="px-6 py-3 border-b-2 font-medium text-sm transition-colors">
              📊 Overview
            </button>
            <button
              (click)="changeReport('students')"
              [class.border-indigo-500]="selectedReport() === 'students'"
              [class.text-indigo-600]="selectedReport() === 'students'"
              [class.border-transparent]="selectedReport() !== 'students'"
              [class.text-gray-500]="selectedReport() !== 'students'"
              class="px-6 py-3 border-b-2 font-medium text-sm transition-colors">
              👥 Students
            </button>
            <button
              (click)="changeReport('courses')"
              [class.border-indigo-500]="selectedReport() === 'courses'"
              [class.text-indigo-600]="selectedReport() === 'courses'"
              [class.border-transparent]="selectedReport() !== 'courses'"
              [class.text-gray-500]="selectedReport() !== 'courses'"
              class="px-6 py-3 border-b-2 font-medium text-sm transition-colors">
              📚 Courses
            </button>
            <button
              (click)="changeReport('revenue')"
              [class.border-indigo-500]="selectedReport() === 'revenue'"
              [class.text-indigo-600]="selectedReport() === 'revenue'"
              [class.border-transparent]="selectedReport() !== 'revenue'"
              [class.text-gray-500]="selectedReport() !== 'revenue'"
              class="px-6 py-3 border-b-2 font-medium text-sm transition-colors">
              💰 Revenue
            </button>
          </nav>
        </div>
      </div>

      <!-- Overview Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Students -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium text-gray-600">Total Students</h3>
            @if (getTrendIndicator(analyticsData()!.overview.totalStudents, analyticsData()!.overview.previousStudents); as trend) {
              <span [class]="trend === 'up' ? 'text-green-600' : trend === 'down' ? 'text-red-600' : 'text-gray-600'">
                {{ trend === 'up' ? '↗' : trend === 'down' ? '↘' : '→' }}
              </span>
            }
          </div>
          <p class="text-3xl font-bold text-gray-900">{{ analyticsData()!.overview.totalStudents }}</p>
          <p class="text-sm mt-2">
            <span [class]="getPercentageChange(analyticsData()!.overview.totalStudents, analyticsData()!.overview.previousStudents) > 0 ? 'text-green-600' : 'text-red-600'">
              {{ getPercentageChange(analyticsData()!.overview.totalStudents, analyticsData()!.overview.previousStudents) | number:'1.1-1' }}%
            </span>
            <span class="text-gray-600"> vs last period</span>
          </p>
        </div>

        <!-- Active Students -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium text-gray-600">Active Students</h3>
            @if (getTrendIndicator(analyticsData()!.overview.activeStudents, analyticsData()!.overview.previousActive); as trend) {
              <span [class]="trend === 'up' ? 'text-green-600' : trend === 'down' ? 'text-red-600' : 'text-gray-600'">
                {{ trend === 'up' ? '↗' : trend === 'down' ? '↘' : '→' }}
              </span>
            }
          </div>
          <p class="text-3xl font-bold text-gray-900">{{ analyticsData()!.overview.activeStudents }}</p>
          <p class="text-sm mt-2">
            <span [class]="getPercentageChange(analyticsData()!.overview.activeStudents, analyticsData()!.overview.previousActive) > 0 ? 'text-green-600' : 'text-red-600'">
              {{ getPercentageChange(analyticsData()!.overview.activeStudents, analyticsData()!.overview.previousActive) | number:'1.1-1' }}%
            </span>
            <span class="text-gray-600"> vs last period</span>
          </p>
        </div>

        <!-- Total Revenue -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium text-gray-600">Total Revenue</h3>
            @if (getTrendIndicator(analyticsData()!.overview.totalRevenue, analyticsData()!.overview.previousRevenue); as trend) {
              <span [class]="trend === 'up' ? 'text-green-600' : trend === 'down' ? 'text-red-600' : 'text-gray-600'">
                {{ trend === 'up' ? '↗' : trend === 'down' ? '↘' : '→' }}
              </span>
            }
          </div>
          <p class="text-3xl font-bold text-gray-900">${{ analyticsData()!.overview.totalRevenue | number }}</p>
          <p class="text-sm mt-2">
            <span [class]="getPercentageChange(analyticsData()!.overview.totalRevenue, analyticsData()!.overview.previousRevenue) > 0 ? 'text-green-600' : 'text-red-600'">
              {{ getPercentageChange(analyticsData()!.overview.totalRevenue, analyticsData()!.overview.previousRevenue) | number:'1.1-1' }}%
            </span>
            <span class="text-gray-600"> vs last period</span>
          </p>
        </div>

        <!-- Average Score -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium text-gray-600">Average Score</h3>
            @if (getTrendIndicator(analyticsData()!.overview.averageScore, analyticsData()!.overview.previousScore); as trend) {
              <span [class]="trend === 'up' ? 'text-green-600' : trend === 'down' ? 'text-red-600' : 'text-gray-600'">
                {{ trend === 'up' ? '↗' : trend === 'down' ? '↘' : '→' }}
              </span>
            }
          </div>
          <p class="text-3xl font-bold text-gray-900">{{ analyticsData()!.overview.averageScore }}%</p>
          <p class="text-sm mt-2">
            <span [class]="getPercentageChange(analyticsData()!.overview.averageScore, analyticsData()!.overview.previousScore) > 0 ? 'text-green-600' : 'text-red-600'">
              {{ getPercentageChange(analyticsData()!.overview.averageScore, analyticsData()!.overview.previousScore) | number:'1.1-1' }}%
            </span>
            <span class="text-gray-600"> vs last period</span>
          </p>
        </div>
      </div>

      <!-- Charts Section -->
      @if (chartData()) {
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

          <!-- Bar Chart -->
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Enrollment Trends</h3>
            <div class="h-64">
              <div class="flex items-end justify-between h-full gap-2">
                @for (value of chartData()!.datasets[0].data; track $index) {
                  <div class="flex-1 flex flex-col items-center gap-2">
                    <div
                      class="w-full bg-indigo-600 rounded-t transition-all hover:bg-indigo-700"
                      [style.height.%]="getBarHeight(value, getMaxValue(chartData()!.datasets[0].data))"
                      [title]="value.toString()">
                    </div>
                    <span class="text-xs text-gray-600">{{ chartData()!.labels[$index] }}</span>
                  </div>
                }
              </div>
            </div>
          </div>

          <!-- Revenue Chart -->
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue Trends</h3>
            <div class="h-64">
              <div class="flex items-end justify-between h-full gap-2">
                @for (value of chartData()!.datasets[1].data; track $index) {
                  <div class="flex-1 flex flex-col items-center gap-2">
                    <div
                      class="w-full bg-green-600 rounded-t transition-all hover:bg-green-700"
                      [style.height.%]="getBarHeight(value, getMaxValue(chartData()!.datasets[1].data))"
                      [title]="'$' + value">
                    </div>
                    <span class="text-xs text-gray-600">{{ chartData()!.labels[$index] }}</span>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      }

      <!-- Student Analytics -->
      @if (selectedReport() === 'students' && analyticsData()!.studentMetrics) {
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

          <!-- Top Performers -->
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">🏆 Top Performers</h3>
            <div class="space-y-3">
              @for (student of analyticsData()!.studentMetrics!.topPerformers; track student.name) {
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <div class="flex-1">
                    <p class="font-medium text-gray-900">{{ student.name }}</p>
                    <div class="flex items-center gap-4 mt-1">
                      <span class="text-sm text-gray-600">Score: <span class="font-semibold text-green-600">{{ student.score }}%</span></span>
                      <span class="text-sm text-gray-600">Progress: <span class="font-semibold text-blue-600">{{ student.progress }}%</span></span>
                    </div>
                  </div>
                  <span class="text-2xl">{{ $index === 0 ? '🥇' : $index === 1 ? '🥈' : $index === 2 ? '🥉' : '⭐' }}</span>
                </div>
              }
            </div>
          </div>

          <!-- Engagement Rate -->
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">📈 Engagement Rate</h3>
            <div class="flex flex-col items-center justify-center py-8">
              <div class="relative w-48 h-48">
                <svg class="transform -rotate-90" viewBox="0 0 200 200">
                  <circle cx="100" cy="100" r="80" fill="none" stroke="#E5E7EB" stroke-width="20"/>
                  <circle
                    cx="100"
                    cy="100"
                    r="80"
                    fill="none"
                    stroke="#4F46E5"
                    stroke-width="20"
                    [attr.stroke-dasharray]="(2 * 3.14159 * 80)"
                    [attr.stroke-dashoffset]="(2 * 3.14159 * 80) * (1 - analyticsData()!.studentMetrics!.engagementRate / 100)"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span class="text-4xl font-bold text-gray-900">{{ analyticsData()!.studentMetrics!.engagementRate }}%</span>
                </div>
              </div>
              <p class="mt-4 text-gray-600">Students actively engaged</p>
            </div>
          </div>
        </div>
      }

      <!-- Course Analytics -->
      @if (selectedReport() === 'courses' && analyticsData()!.courseMetrics) {
        <div class="bg-white rounded-lg shadow p-6 mb-8">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">📚 Most Popular Courses</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            @for (course of analyticsData()!.courseMetrics!.mostPopular; track course.name) {
              <div class="border rounded-lg p-4">
                <h4 class="font-medium text-gray-900 mb-2">{{ course.name }}</h4>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Enrollments:</span>
                    <span class="font-semibold">{{ course.enrollments }}</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Rating:</span>
                    <span class="font-semibold text-yellow-600">{{ course.rating }} ⭐</span>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Revenue Analytics -->
      @if (selectedReport() === 'revenue' && analyticsData()!.revenueMetrics) {
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

          <!-- Revenue by Plan -->
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">💰 Revenue by Plan</h3>
            <div class="space-y-3">
              @for (plan of analyticsData()!.revenueMetrics!.byPlan | keyvalue; track plan.key) {
                <div>
                  <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">{{ plan.key }}</span>
                    <span class="text-sm font-bold text-gray-900">${{ plan.value | number }}</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div
                      class="bg-green-600 h-2 rounded-full"
                      [style.width.%]="(plan.value / 24200) * 100">
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Subscription Trends -->
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">📊 Subscription Trends</h3>
            <div class="space-y-4">
              <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                <div>
                  <p class="text-sm text-gray-600">New Subscriptions</p>
                  <p class="text-2xl font-bold text-green-900">{{ analyticsData()!.revenueMetrics!.subscriptionTrends.new }}</p>
                </div>
                <span class="text-3xl">✨</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                <div>
                  <p class="text-sm text-gray-600">Renewals</p>
                  <p class="text-2xl font-bold text-blue-900">{{ analyticsData()!.revenueMetrics!.subscriptionTrends.renewals }}</p>
                </div>
                <span class="text-3xl">🔄</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                <div>
                  <p class="text-sm text-gray-600">Cancellations</p>
                  <p class="text-2xl font-bold text-red-900">{{ analyticsData()!.revenueMetrics!.subscriptionTrends.cancellations }}</p>
                </div>
                <span class="text-3xl">⚠️</span>
              </div>
            </div>
          </div>
        </div>
      }
    }
  </div>
</div>
