<!-- Modal Overlay -->
<div class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-8 relative max-h-[90vh] overflow-y-auto">
    <button class="absolute top-3 right-4 text-2xl text-gray-400 hover:text-red-500" (click)="close.emit()">×</button>
    <h2 class="text-xl font-bold mb-6 text-blue-900 text-center">Add New Teacher</h2>
    <form [formGroup]="addUserForm" (ngSubmit)="onSubmit()" autocomplete="off">
      <div class="mb-4">
        <label class="block mb-1 font-semibold">Username</label>
        <div class="relative">
          <input formControlName="userName" class="w-full border rounded px-3 py-2"
                 autocomplete="new-username"
                 [class.border-red-500]="validationErrors['userName']" />
          @if (checkingUsername()) {
            <div class="absolute right-3 top-2.5">
              <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          }
        </div>
        @if (addUserForm.get('userName')?.hasError('required') && addUserForm.get('userName')?.touched) {
          <small class="text-red-500 block mt-1">Username is required.</small>
        }
        @if (addUserForm.get('userName')?.hasError('minlength') && addUserForm.get('userName')?.touched) {
          <small class="text-red-500 block mt-1">Username must be at least 4 characters.</small>
        }
        @if (addUserForm.get('userName')?.hasError('numbersOnly') && addUserForm.get('userName')?.touched) {
          <small class="text-red-500 block mt-1">Username cannot be only numbers.</small>
        }
        @if (addUserForm.get('userName')?.hasError('invalidChars') && addUserForm.get('userName')?.touched) {
          <small class="text-red-500 block mt-1">Username can only contain letters, numbers, and underscores.</small>
        }
        @if (addUserForm.get('userName')?.hasError('usernameTaken') && addUserForm.get('userName')?.touched) {
          <small class="text-red-500 block mt-1">❌ This username is already taken.</small>
        }
        @if (!addUserForm.get('userName')?.hasError('usernameTaken') && !checkingUsername() && addUserForm.get('userName')?.valid && addUserForm.get('userName')?.touched) {
          <small class="text-green-600 block mt-1">✅</small>
        }
        @if (validationErrors['userName']) {
          @for (error of validationErrors['userName']; track error) {
            <small class="block text-red-500 mt-1">{{ error }}</small>
          }
        }
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-semibold">Email</label>
        <div class="relative">
          <input formControlName="email" type="email" class="w-full border rounded px-3 py-2"
                 autocomplete="email"
                 [class.border-red-500]="validationErrors['email']" />
          @if (checkingEmail()) {
            <div class="absolute right-3 top-2.5">
              <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          }
        </div>
        @if (addUserForm.get('email')?.hasError('required') && addUserForm.get('email')?.touched) {
          <small class="text-red-500 block mt-1">Email is required.</small>
        }
        @if (addUserForm.get('email')?.hasError('email') && addUserForm.get('email')?.touched) {
          <small class="text-red-500 block mt-1">Please enter a valid email address (e.g. user@example.com).</small>
        }
        @if (addUserForm.get('email')?.hasError('emailTaken') && addUserForm.get('email')?.touched) {
          <small class="text-red-500 block mt-1">❌ This email is already registered.</small>
        }
        @if (!addUserForm.get('email')?.hasError('emailTaken') && !checkingEmail() && addUserForm.get('email')?.valid && addUserForm.get('email')?.touched) {
          <small class="text-green-600 block mt-1">✅</small>
        }
        @if (validationErrors['email']) {
          @for (error of validationErrors['email']; track error) {
            <small class="block text-red-500 mt-1">{{ error }}</small>
          }
        }
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-semibold">Password</label>
        <input formControlName="password" type="password" class="w-full border rounded px-3 py-2"
               autocomplete="new-password"
               [class.border-red-500]="validationErrors['password']" />
        @if (addUserForm.get('password')?.hasError('required') && addUserForm.get('password')?.touched) {
          <small class="text-red-500">Password is required.</small>
        }
        @if (addUserForm.get('password')?.hasError('minlength') && addUserForm.get('password')?.touched) {
          <small class="text-red-500">Password must be at least 8 characters.</small>
        }
        @if (validationErrors['password']) {
          @for (error of validationErrors['password']; track error) {
            <small class="block text-red-500 mt-1">{{ error }}</small>
          }
        }
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-semibold">Phone Number</label>
        <div class="relative">
          <input formControlName="phoneNumber" class="w-full border rounded px-3 py-2"
                 [class.border-red-500]="validationErrors['phoneNumber']" />
          @if (checkingPhone()) {
            <div class="absolute right-3 top-2.5">
              <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          }
        </div>
        @if (addUserForm.get('phoneNumber')?.invalid && addUserForm.get('phoneNumber')?.touched) {
          <small class="text-red-500 block mt-1">Phone number is required.</small>
        }
        @if (addUserForm.get('phoneNumber')?.hasError('phoneTaken') && addUserForm.get('phoneNumber')?.touched) {
          <small class="text-red-500 block mt-1">❌ This phone number is already registered.</small>
        }
        @if (!addUserForm.get('phoneNumber')?.hasError('phoneTaken') && !checkingPhone() && addUserForm.get('phoneNumber')?.valid && addUserForm.get('phoneNumber')?.touched) {
          <small class="text-green-600 block mt-1">✅</small>
        }
        @if (validationErrors['phoneNumber']) {
          @for (error of validationErrors['phoneNumber']; track error) {
            <small class="block text-red-500 mt-1">{{ error }}</small>
          }
        }
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-semibold">Age</label>
        <input formControlName="age" type="number" class="w-full border rounded px-3 py-2" />
        @if (addUserForm.get('age')?.hasError('required') && addUserForm.get('age')?.touched) {
          <small class="text-red-500">Age is required.</small>
        }
        @if (addUserForm.get('age')?.hasError('min') && addUserForm.get('age')?.touched) {
          <small class="text-red-500">Age must be at least 18.</small>
        }
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-semibold">Salary (Optional)</label>
        <input formControlName="salary" type="number" class="w-full border rounded px-3 py-2" placeholder="Enter teacher's salary"
               [class.border-red-500]="validationErrors['salary']" />
        @if (addUserForm.get('salary')?.hasError('min') && addUserForm.get('salary')?.touched) {
          <small class="text-red-500">Salary must be a positive number.</small>
        }
        @if (validationErrors['salary']) {
          @for (error of validationErrors['salary']; track error) {
            <small class="block text-red-500 mt-1">{{ error }}</small>
          }
        }
      </div>
      <div class="mb-6">
        <label class="block mb-1 font-semibold">IBAN (Optional)</label>
        <input formControlName="iban" type="text" class="w-full border rounded px-3 py-2" placeholder="Enter IBAN number"
               [class.border-red-500]="validationErrors['iban']" />
        @if (addUserForm.get('iban')?.hasError('pattern') && addUserForm.get('iban')?.touched) {
          <small class="text-red-500">Invalid IBAN format.</small>
        }
        @if (validationErrors['iban']) {
          @for (error of validationErrors['iban']; track error) {
            <small class="block text-red-500 mt-1">{{ error }}</small>
          }
        }
      </div>
      <button type="submit" class="w-full bg-primary-500 hover:bg-primary-600 text-white font-semibold py-2 rounded" [disabled]="loading">
        <span *ngIf="!loading">Add Teacher</span>
        <span *ngIf="loading">Adding...</span>
      </button>
      @if (error) {
        <div class="text-red-600 mt-3 text-center">{{ error }}</div>
      }
    </form>
  </div>
</div>
